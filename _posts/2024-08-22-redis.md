---
layout : single
title : "[Project] SpringBoot-Redis : ì´ë©”ì¼ ê²€ì¦ ë° ì„ì‹œ member ì €ì¥"
categories: Project
tag : [project1, practice]
author_profile: true
---

ğŸ“Œ ê°œì¸ì ì¸ ê³µê°„ìœ¼ë¡œ ê³µë¶€ë¥¼ ê¸°ë¡í•˜ê³  ë³µìŠµí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. <br>
ì •í™•í•˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ë°”ëë‹ˆë‹¤ :ğŸ˜¸ <br>
[í‹€ë¦° ë‚´ìš©ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ë³µë°›ìœ¼ì‹¤ê±°ì—ìš”]  
{: .notice--primary}

---

íšŒì› ê°€ì…ì‹œ ì¸ì¦í•˜ëŠ” ì ˆì°¨ë¥¼ ìœ„í•´ì„œ ì•„ë˜ 2ê°€ì§€ ë¡œì§ì´ í•„ìš”í–ˆê³  ì´ë¥¼ ìœ„í•´ì„  Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í•„ìš”í–ˆë‹¤.

1. ì´ë©”ì¼ + ì¸ì¦ì½”ë“œ ì €ì¥
    
    ì§€ë‚œë²ˆ SMTPì— ì´ì–´ ì´ë©”ì¼ ì¸ì¦ ì½”ë“œë¥¼ ë³´ë‚¼ ë•Œ Redisì— emailì„ í‚¤ë¡œ ì €ì¥ í›„ Valueë¡œ ì¸ì¦ ì½”ë“œë¥¼ ì €ì¥í•œ ë‹¤ìŒ ì‚¬ìš©ìê°€ ì¸ì¦ì½”ë“œ ì…ë ¥ì‹œ Redisì— ì €ì¥ëœ ì½”ë“œì™€ ë¹„êµí•˜ì—¬ ì¼ì¹˜í•˜ë©´ íšŒì›ê°€ì… ì™„ë£Œê°€ ë˜ê³  redisì— ì €ì¥ëœ ê°’ì€ ì‚­ì œëœë‹¤.
    
2. ì´ë©”ì¼  + Member ì €ì¥
    
     memberê°€ ì„ì‹œë¡œ redisë¡œ ì €ì¥ë˜ê³  ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ memberê°€ ê°€ì… ëœ í›„ redisì—ì„œëŠ” ì‚­ì œë˜ê³  DBì— ì €ì¥ë˜ëŠ” ë¡œì§
    

## Redis ì„¤ì¹˜

ë…¸íŠ¸ë¶ì— Ubuntu ì„¤ì¹˜ë˜ì–´ ìˆì–´ì„œ Ubuntu ì—ì„œ Redis ì„¤ì¹˜ í›„ ì„œë²„ë¥¼ ì—´ì—ˆë‹¤.

1. ubuntu ì—ì„œ redis ì„¤ì¹˜
    
    ```
    # apt-get update
    $ sudo apt-get update
    $ sudo apt-get upgrade
    
    # redis ì„¤ì¹˜
    $ sudo apt-get install redis-server
    ```
    
2. ìì£¼ ì“°ê²Œ ë˜ëŠ” ëª…ë ¹ì–´
    
    ```
    redis ì‹œì‘ : sudo systemctl status redis-server
    cli í™˜ê²½ ì—´ê¸° : redis-cli
    
    ëª¨ë“  í‚¤ ì¡°íšŒ : keys *
    ë°ì´í„° ì§€ìš°ê¸° : FLUSHALL
    hash kye field í™•ì¸ : hkeys <key>
    hash key value í™•ì¸ : hvals <key>
    ```
    

## Redis ê´€ë ¨ ì„¤ì • ë° í´ë˜ìŠ¤ ìƒì„±

### ì˜ì¡´ì„± ì¶”ê°€

```
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
```

### application.yml 

```
redis:
  host: localhost
  port: 6379
```

### RedisConfiguration

```java
@Configuration
public class RedisConfig {
    @Value("${redis.host}")
    private String redisHost;

    @Value("${redis.port}")
    private int redisPort;

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        // LettuceConnectionFactoryë¥¼ ì‚¬ìš©í•˜ì—¬ Redisì™€ ì—°ê²°
        return new LettuceConnectionFactory(redisHost,redisPort);
    }

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        return template;
    }

    @Bean
    public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory connectionFactory) {
        return new StringRedisTemplate(connectionFactory);
    }

}
```

### RedisUtils

```java
@RequiredArgsConstructor
@Service
@Slf4j
public class RedisUtil {
    private final RedisTemplate<String, Object> redisTemplate;

// ë¬¸ìì—´ ë°ì´í„° ì„¤ì •
    public void setDataWithExpire(String key, String value, long duration) {
        ValueOperations<String, Object> valueOps = redisTemplate.opsForValue();
        Duration expireDuration = Duration.ofSeconds(duration);
        valueOps.set(key, value, expireDuration);
    }

    // ë¬¸ìì—´ ë°ì´í„° ì¡°íšŒ
    public String getData(String key) {
        ValueOperations<String, Object> valueOps = redisTemplate.opsForValue();
        return (String) valueOps.get(key);
    }
}
```

## ì´ë©”ì¼ ì¸ì¦ì½”ë“œ ê²€ì¦

### EmailService

```java
 public String sendMail(EmailMessage emailMessage, String type) {
        String authNumber = createCode();
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();

        try {
            MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, false, "UTF-8");
            mimeMessageHelper.setTo(emailMessage.getTo());
            mimeMessageHelper.setSubject(emailMessage.getSubject());
            mimeMessageHelper.setText(setContext(authNumber, type), true);

            // ì¸ì¦ ì½”ë“œ Redisì— ì €ì¥
            String hashedEmail = emailMessage.getTo() +":auth";
            redisUtil.setDataWithExpire(hashedEmail, authNumber, authCodeExpiration);

            javaMailSender.send(mimeMessage);
            log.info("Success");
            return authNumber;

        } catch (MessagingException e) {
            log.info("fail");
            throw new RuntimeException(e);
        }
    }
```

- Email ë³´ë‚´ëŠ” ì‹œì ì— keyëŠ” email+â€authâ€, valueëŠ” authCode ê·¸ë¦¬ê³  ë§Œë£Œì‹œê°„ì„ 10ë¶„ìœ¼ë¡œ ì €ì¥í•˜ì˜€ë‹¤.
- ì•„ë˜ ë©”ì„œë“œì—ì„œëŠ” ì½”ë“œê°€ redisì— ì €ì¥ëœ ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
    
    <img src="https://github.com/user-attachments/assets/6aa69b87-7550-41d3-952a-a6d80f6aef2a" width=500/>
    

### MemberController

```java
    @PostMapping("/signup")
    public ResponseEntity postMember(@RequestBody @Valid MemberPostDto postDto) {
        memberService.createMember(mapper.memberPostDtoToMember(postDto));
        return new ResponseEntity<>(HttpStatus.OK);
    }

    // ì´ë©”ì¼ ì¸ì¦ ì°½ìœ¼ë¡œ ë„˜ì–´ê°€ì„œ ì¸ì¦ì½”ë“œ ì…ë ¥ì¹¸ì— ì¸ì¦ì½”ë“œë¥¼ ì…ë ¥ í›„ í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥¼ë•Œ
    @PostMapping("/verify")
    public ResponseEntity registerMember(@RequestBody VerificationDto verificationDto) {
        URI location = URI.create("");
        if (emailService.verifyEmailCode(verificationDto)) {
            Member member = memberService.registerMember(verificationDto);

            location = UriComponentsBuilder
                    .newInstance()
                    .path(MEMBER_DEFAULT_URL + "/{memberId}")
                    .buildAndExpand(member.getMemberId())
                    .toUri();
        }
        return ResponseEntity.created(location).build();
    }
```

- memberControllerì—ì„œ email ì¸ keyë¥¼ í†µí•´ ì¸ì¦ì½”ë“œë¥¼ getí•œ ë‹¤ìŒ, ë™ì¼í•˜ì§€ ì•Šê±°ë‚˜ nullì¼ ê²½ìš°ì—ëŠ” ì˜ˆì™¸ë¥¼ ë˜ì§€ê³  ë™ì¼í•˜ë‹¤ë©´ trueë¥¼ ë°˜í™˜í•˜ê²Œ í•œë‹¤.
- ê·¸ í›„ memberControllerì—ì„œ trueì¸ì§€ falseì¸ì§€ íŒë‹¨ í•œ ë‹¤ìŒ ì¸ì¦ì½”ë“œë¥¼ ìœ„í•´ ì‚¬ìš©í–ˆë˜ ì´ë©”ì¼ keyëŠ” ì‚­ì œí•˜ê³  memberë“±ë¡ì´ ì§„í–‰ëœë‹¤.
- ì´ë©”ì¼ ì¸ì¦ì½”ë“œê°€ ì¼ì¹˜í•œë‹¤ë©´ (true)  memberServiceì˜ registerMemberë¥¼ í˜¸ì¶œ í•œë‹¤.

## Memberì •ë³´ë¥¼ Redisì— ì €ì¥

### MemberService

```java
@Service
public class MemberService {
    private final MemberRepository repository;
    private final PasswordEncoder passwordEncoder;
    private final JwtAuthorityUtils jwtAuthorityUtils;
    private final RedisUtil redisUtil;

    public MemberService(MemberRepository repository, PasswordEncoder passwordEncoder, JwtAuthorityUtils jwtAuthorityUtils, EmailService emailService, RedisUtil redisUtil) {
        this.repository = repository;
        this.passwordEncoder = passwordEncoder;
        this.jwtAuthorityUtils = jwtAuthorityUtils;
        this.redisUtil = redisUtil;
    }

    public void createMember(Member member) {
        verifiedExistNickname(member.getNickname());
        verifiedExistEmail(member.getEmail());

        String key = member.getEmail();
        
        //redisì— ì €ì¥
        redisUtil.setHashValueWithExpire(key, "memberInfo", member, 600);

    }
    
    //  ì¸ì¦ì½”ë“œ í™•ì¸ í›„ íšŒì› ë“±ë¡ ì—¬ë¶€ ê²°ì •
    public Member registerMember(VerificationDto verificationDto) {
        String key = verificationDto.getEmail();
        Member member = redisUtil.getHashValue(key, "memberInfo", Member.class);
        if (member == null) {
            throw new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND);
        }
				redisTemplate.delete(key);
        member.setPassword(passwordEncoder.encode(member.getPassword()));
        List<String> roles = jwtAuthorityUtils.createRoles(member.getEmail());
        member.setRoles(roles);
        return repository.save(member);
    }
}

```

- createMember ë©”ì„œë“œì—ì„œ keyëŠ” email, valueë¡œëŠ” memberë¥¼ ì €ì¥í•˜ê³  hashKeyë¡œ memberInfo ë¥¼ ì‚¬ìš©í•œë‹¤.
- ì¸ì¦ì½”ë“œê°€ ë§ë‹¤ë©´ registerMember ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ê³   redisì—ì„œ memberë¥¼ ê°€ì ¸ì™”ì„ ë•Œ  memberê°€ ì—†ìœ¼ë©´ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ê³  ìˆë‹¤ë©´ memberê°€ DBì— ì €ì¥ë˜ëŠ” ë¡œì§ì´ë‹¤.
- memberê°€ ìˆë‹¤ë©´ redisì—ì„œ keyë¥¼ ì‚­ì œí•œë‹¤.
- redisì— memberê°€ ì €ì¥ë  ë•Œ ì•„ë˜ì™€ ê°™ì´ ì €ì¥ë˜ì–´ìˆë‹¤.
    - **key**
        
        keyëŠ” ë‚´ê°€ ì…ë ¥í•œ email+â€:emailâ€ ì´ë‹¤.
        
    - **hasykey**
        
        <img src="https://github.com/user-attachments/assets/6977c895-b1ac-467a-99d2-92260f635765" width=500/>
        
    - **value**
        
        <img src="https://github.com/user-attachments/assets/cab7b46a-7b97-4d41-b3b2-a999b5686374" width=500/>
        

## Trouble shooting

### ClassCastException ë°œìƒ

<img src="https://github.com/user-attachments/assets/b13a9017-3c76-4598-b4cf-96f4fe5bcc0a" width=500/>

1. ì›ì¸ 
    - ì²«ë²ˆ ì§¸ , ì§ë ¬í™” ë¬¸ì œ
    ì§ë ¬í™” ë©”ì„œë“œ ìƒì„±
            
     ```java
    private void setSerializers(RedisTemplate<?, Object> template) {
        // keyì™€ hashKeyëŠ” StringRedisSerializerë¥¼ ì‚¬ìš©
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        template.setKeySerializer(stringRedisSerializer);
        template.setHashKeySerializer(stringRedisSerializer);
            
        // valueì™€ hashValueëŠ” Jackson2JsonRedisSerializerë¥¼ ì‚¬ìš©
        Jackson2JsonRedisSerializer<Object> jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        objectMapper.activateDefaultTyping(objectMapper.getPolymorphicTypeValidator(), ObjectMapper.DefaultTyping.NON_FINAL);
        objectMapper.registerModule(new JavaTimeModule());
            
        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
            
        template.setValueSerializer(jackson2JsonRedisSerializer);
        template.setHashValueSerializer(jackson2JsonRedisSerializer);
            
        template.afterPropertiesSet();
            }
    ```   
            
    - ë‘ë²ˆ ì§¸ ,  Redis ì„¤ì •í•  ë•Œ ì´ë©”ì¼ ê²€ì¦ë•Œ ë§Œë“¤ì—ˆë˜ Temaplateì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë ¤ í•´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ë‹¤.
        
        <img src="https://github.com/user-attachments/assets/c900f42b-bce4-48ce-a690-0509fe0e7846" width=500/>
        
    - Member ë¼ëŠ” ê°ì²´ë¥¼ String ìœ¼ë¡œ ì €ì¥í•˜ë ¤ê³  í•´ì„œ ClassCastExceptionì´ ë°œìƒí–ˆê³  í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” RedisUtilsì— ê°ì²´ ë°ì´í„°ë¥¼ ì„¤ì •í•´ì¤„ ìˆ˜ ìˆëŠ” ë©”ì„œë“œë¥¼ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ ì£¼ì–´ì•¼ í•œë‹¤.
2. ì¶”ê°€ ì„¤ì • í•„ìš”
    - RedisUtilsì— ê°ì²´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ ì¶”ê°€ ìƒì„±
        
        <img src="https://github.com/user-attachments/assets/f2ad0beb-f95b-4009-9ffb-5deb432ee92e" width=500/>
        
        - MemberëŠ” í•´ì‹œë¥¼ ì‚¬ìš©í•´ì„œ memberInfoë¼ëŠ” í•„ë“œì— íšŒì›ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê²Œ ì„¤ì •í•  ê±´ë° í•´ì‹œë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” íšŒì›ì˜ ì •ë³´ë¥¼ ê·¸ë£¹í™” í•  ìˆ˜ ìˆê³  ì´ë¡œ ì¸í•´ ë©”ëª¨ë¦¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
3. í•´ê²°
    - í•´ë‹¹ ë©”ì„œë“œë¥¼ ë§Œë“¤ê³  ë‚˜ì„œëŠ” í•´ê²°ì´ ë˜ì—ˆìœ¼ë‚˜ ì•„ë˜ì— ë˜ ë‹¤ë¥¸ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.

<br>

### ì§ë ¬í™” ë¬¸ì œ (@JsonBackReference / @JsonManagedReference )

<img src="https://github.com/user-attachments/assets/efd866f6-8b02-4cd3-b92b-77252da1b58f" width=500/>

1. ì›ì¸
    
    ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ë§¤í•‘ì‹œ ìˆœí™˜ì°¸ì¡°ë¥¼ ë§‰ê¸° ìœ„í•´ì„œ ì—°ê´€ê´€ê³„ ë§¤í•‘í•  ë•Œ `@JsonBackReference`ì™€ `@JsonManagedReference` ì• ë„ˆí…Œì´ì…˜ì„ ë‹¬ì•˜ëŠ”ë° ê·¸ê²Œ ë„ˆë¬´ ë§ì•„ì„œ ì–´ë–¤ ê°’ì„ ì—­ì§ë ¬í™” í•´ì•¼í•˜ëŠ”ì§€ í˜¼ì„ ì´ ì™€ì„œ ê·¸ë ‡ë‹¤ê³  í•œë‹¤.
    
2. ê°œì„ 
    - í•´ë‹¹ ì• ë„ˆí…Œì´ì…˜ ì˜†ì— ì°¸ì¡°í•  ì´ë¦„ì„ ëª…ì‹œí•´ ì£¼ë©´ ëœë‹¤.
    - ëª¨ë“  í´ë˜ìŠ¤ì˜ ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•¨.
        - ëŒ€í‘œì ìœ¼ë¡œ Post í´ë˜ìŠ¤ì˜ ì—°ê´€ê´€ê³„ëŠ” ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í–ˆë‹¤.
            - postì™€ heartì˜ ì—°ê´€ê´€ê³„ì—ì„œëŠ” â€œpost-heartâ€ë¼ê³  ëª…ì‹œí•´ë‘ì—ˆê³ 
            
            <img src="https://github.com/user-attachments/assets/0849559b-9d65-464a-8b2a-12ab83651e91" width=350/>
            
        
        - Heartì—ë„ ë§ˆì°¬ê°€ì§€ë¡œ â€œpost-heartâ€ë¼ê³  ëª…ì‹œí•¨
            
           <img src="https://github.com/user-attachments/assets/837034e1-b771-4621-b030-df0e8652f32d" width=350/>
            
    
3. í•´ê²°
    
    ë¬¸ì œ ì—†ì´ member ê°€ ì˜ ë§Œë“¤ì–´ì§„ë‹¤.
    
    <img src="https://github.com/user-attachments/assets/4fc13fe7-858f-44c1-a374-62e13b2b46da" width=500/>