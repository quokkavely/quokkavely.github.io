---
layout : single
title : "[Security] JWT(JSON Web Token)"
categories: Spring
tag : [Spring, ì‹¤ìŠµ, Security]
author_profile: true
---

ğŸ“Œ ê°œì¸ì ì¸ ê³µê°„ìœ¼ë¡œ ê³µë¶€ë¥¼ ê¸°ë¡í•˜ê³  ë³µìŠµí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. <br>
ì •í™•í•˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ë°”ëë‹ˆë‹¤ :ğŸ˜¸ <br>
[í‹€ë¦° ë‚´ìš©ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ë³µë°›ìœ¼ì‹¤ê±°ì—ìš”]  
{: .notice--primary}


# JWT(JSON Web Token)

## í† í° ê¸°ë°˜ ìê²© ì¦ëª…

### ì„¸ì…˜ê¸°ë°˜ ìê²© ì¦ëª…

**ì„¸ì…˜ ê¸°ë°˜ ìê²© ì¦ëª… ë°©ì‹**ì€ ì„œë²„ ì¸¡ì— ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì„¸ì…˜ í˜•íƒœë¡œ ì„¸ì…˜ ì €ì¥ì†Œì— ì €ì¥í•˜ëŠ” ë°©ì‹ì´ë‹¤.

- ì„¸ì…˜ ê¸°ë°˜ ìê²© ì¦ëª…ì˜ íŠ¹ì§•
    - ì„¸ì…˜ì€ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ **ì„œë²„ ì¸¡ ì„¸ì…˜ ì €ì¥ì†Œì—ì„œ ê´€ë¦¬**í•œë‹¤.
    - ìƒì„±ëœ ì‚¬ìš©ì ì„¸ì…˜ì˜ ê³ ìœ  IDì¸ ì„¸ì…˜ IDëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ì¿ í‚¤ì— ì €ì¥ë˜ì–´ request ì „ì†¡ ì‹œ, ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ë¥¼ ì¦ëª…í•˜ëŠ” ìˆ˜ë‹¨ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.
    - ì„¸ì…˜ IDë§Œ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ ì‚¬ìš©í•˜ë¯€ë¡œ **ìƒëŒ€ì ìœ¼ë¡œ ì ì€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì‚¬ìš©**í•œë‹¤.
    - ì„œë²„ ì¸¡ì—ì„œ ì„¸ì…˜ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ **ë³´ì•ˆì„± ì¸¡ë©´ì—ì„œ ì¡°ê¸ˆ ë” ìœ ë¦¬**í•˜ë‹¤.
    - ì„œë²„ì˜ í™•ì¥ì„± ë©´ì—ì„œëŠ” **ì„¸ì…˜ ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒ**í•  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.
    - ì„¸ì…˜ ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ì§ˆìˆ˜ë¡ **ì„œë²„ì˜ ë¶€ë‹´ì´ ê°€ì¤‘**ë  ìˆ˜ ìˆë‹¤.
    - **SSR(Server Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì í•©í•œ ë°©ì‹**ì´ë‹¤

### í† í°ê¸°ë°˜ ìê²© ì¦ëª…

**í† í° ê¸°ë°˜ ìê²© ì¦ëª… ë°©ì‹**ì€ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ í† í°ì— ì €ì¥í•˜ê³ , ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•´ ì ‘ê·¼ ê¶Œí•œì´ ë¶€ì—¬ëœ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ë°©ì‹ì´ë‹¤.

- í† í° ê¸°ë°˜ ìê²© ì¦ëª…ì˜ íŠ¹ì§•
    - í† í°ì— í¬í•¨ëœ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ëŠ” ì„œë²„ ì¸¡ì—ì„œ ë³„ë„ì˜ ê´€ë¦¬ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ìƒì„±ëœ í† í°ì„ í—¤ë”ì— í¬í•¨í•´ request ì „ì†¡ ì‹œ, ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ë¥¼ ì¦ëª…í•˜ëŠ” ìˆ˜ë‹¨ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.
    - í† í° ë‚´ì— ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ë“±ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë¯€ë¡œ **ì„¸ì…˜ì— ë¹„í•´ ìƒëŒ€ì ìœ¼ë¡œ ë§ì€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì‚¬ìš©**í•œë‹¤.
    - ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„ ì¸¡ì—ì„œ í† í°ì„ ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë³´ì•ˆì„± ì¸¡ë©´ì—ì„œ ì¡°ê¸ˆ ë” ë¶ˆë¦¬í•˜ë‹¤.
    - ì¸ì¦ëœ ì‚¬ìš©ì requestì˜ ìƒíƒœë¥¼ ìœ ì§€í•  í•„ìš”ê°€ ì—†ê¸° ë•Œë¬¸ì— **ì„œë²„ì˜ í™•ì¥ì„± ë©´ì—ì„œ ìœ ë¦¬í•˜ê³ , ì„¸ì…˜ ë¶ˆì¼ì¹˜ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.**
    - í† í°ì— í¬í•¨ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ëŠ” í† í°ì˜ íŠ¹ì„±ìƒ ì•”í˜¸í™”ê°€ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê³µê²©ìì—ê²Œ í† í°ì´ íƒˆì·¨ë  ê²½ìš°, ì‚¬ìš©ì ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì œê³µí•˜ëŠ” ì…ˆì´ ë˜ë¯€ë¡œ **ë¯¼ê°í•œ ì •ë³´ëŠ” í† í°ì— í¬í•¨í•˜ì§€ ë§ì•„ì•¼ í•œë‹¤.**
    - ê¸°ë³¸ì ìœ¼ë¡œ **í† í°ì´ ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” í† í°ì„ ë¬´íš¨í™”ì‹œí‚¬ ìˆ˜ ì—†ë‹¤.**
    - CSR(Client Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì í•©í•œ ë°©ì‹ì´ë‹¤
    

## JWT(JSON Web Token)

JWTëŠ” ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê³  ê°„ê²°í•˜ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•´ ê³ ì•ˆëœ ì¸í„°ë„· í‘œì¤€ ì¸ì¦ ë°©ì‹ìœ¼ë¡œì¨ í† í° ì¸ì¦ ë°©ì‹ì—ì„œ ê°€ì¥ ë²”ìš©ì ìœ¼ë¡œ ì‚¬ìš©ë˜ë©° JSON í¬ë§·ì˜ í† í° ì •ë³´ë¥¼ ì¸ì½”ë”© í›„, ì¸ì½”ë”© ëœ í† í° ì •ë³´ë¥¼ Secret Keyë¡œ ì„œëª…(Sign)í•œ ë©”ì‹œì§€ë¥¼ Web Tokenìœ¼ë¡œì¨ ì¸ì¦ ê³¼ì •ì— ì‚¬ìš©

JWT ê³µì‹ ì‚¬ì´íŠ¸ : [https://jwt.io/](https://jwt.io/)

### JWTì˜ ì¢…ë¥˜

JWTëŠ” ë³´í†µ ë‹¤ìŒê³¼ ê°™ì´ ë‘ ê°€ì§€ ì¢…ë¥˜ì˜ í† í°ì„ ì‚¬ìš©ìì˜ ìê²© ì¦ëª…ì— ì´ìš©í•œë‹¤ â‡’ **Access Token & Refresh Token**

1. **ì•¡ì„¸ìŠ¤ í† í°(Access Token)**
    - ë³´í˜¸ëœ ì •ë³´ë“¤(ì‚¬ìš©ìì˜ ì´ë©”ì¼, ì—°ë½ì²˜, ì‚¬ì§„ ë“±)ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬ì— ì‚¬ìš©
    - í´ë¼ì´ì–¸íŠ¸ê°€ ì²˜ìŒ ì¸ì¦ì„ ë°›ê²Œ ë  ë•Œ(ë¡œê·¸ì¸ ì‹œ), Access Tokenê³¼ Refresh Token ë‘ ê°€ì§€ë¥¼ ë‹¤ ë°›ì§€ë§Œ, ì‹¤ì œë¡œ ê¶Œí•œì„ ì–»ëŠ” ë° ì‚¬ìš©í•˜ëŠ” í† í°ì€ Access Token
    - ì£¼ìš” ê¶Œí•œì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì—  Access Tokenì—ëŠ” ë¹„êµì  ì§§ì€ ìœ íš¨ ê¸°ê°„ì„ ì£¼ì–´ íƒˆì·¨ë˜ë”ë¼ë„ ì˜¤ë«ë™ì•ˆ ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ í•œë‹¤. â‡’ Access Tokenì˜ ìœ íš¨ê¸°ê°„ì´ ë§Œë£Œëœë‹¤ë©´ Refresh Tokenì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ Access Tokenì„ ë°œê¸‰ë°›ëŠ”ë‹¤. ì´ë•Œ, ì‚¬ìš©ìëŠ” ë‹¤ì‹œ ë¡œê·¸ì¸ ì¸ì¦ì„ í•  í•„ìš”ê°€ ì—†ë‹¤.
2. **ë¦¬í”„ë ˆì‹œ í† í°(Refresh Token)** 
    - ì•¡ì„¸ìŠ¤ í† í°ì„ ì¬ë°œê¸‰ë°›ê¸° ìœ„í•œ ì •ë³´ë§Œ ë‹´ê³  ìˆìŒ.
    - Access Tokenì˜ ìœ íš¨ê¸°ê°„ì´ ë§Œë£Œëœë‹¤ë©´ Refresh Tokenì„ ì‚¬ìš©í•˜ì—¬
    - ë¦¬í”„ë ˆì‰¬í† í°ì€ ìœ íš¨ê¸°ê°„ì´ ê¸¸ê¸° ë•Œë¬¸ì— íƒˆì·¨ë‹¹í•˜ë©´ ë¬¸ì œê°€ ëœë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë¦¬í”„ë ˆì‰¬í† í°ì„ ì¼íšŒìš©ìœ¼ë¡œ ë§Œë“ ë‹¤.
    - ì¦‰ ìƒíƒœë¥¼ ê°€ì§€ì§„ ì•Šì§€ë§Œ. ì•¡ì„¸ìŠ¤ í† í°ì´ ë§Œë£Œë˜ì„œ ë¦¬í”„ë ˆì‹œì—ì„œ ì•¡ì„¸ìŠ¤í† í°ì„ ìš”ì²­ í•  ë•Œ ë¦¬í”„ë ˆì‹œ í† í°ë„ í•¨ê»˜  ì¬ë°œí–‰ í•œë‹¤.
    - ì‚¬ìš©ìì˜ `í¸ì˜`ë³´ë‹¤ `ì •ë³´ë¥¼ ì§€í‚¤ëŠ” ê²ƒì´ ë” ì¤‘ìš”`í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Refresh Tokenì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê³³ì´ ë§ë‹¤.

### JWT êµ¬ì¡°

<img src="https://github.com/quokkavely/quokkavely.github.io/assets/165968530/92febfcf-d6ca-4386-ae23-cba7f576d4bd" width=400 />

JWTëŠ” ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ `.`ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì§„ ì„¸ ë¶€ë¶„ì´ ì¡´ì¬í•œë‹¤.

1. Header
    - HeaderëŠ” ì´ê²ƒì´ ì–´ë–¤ ì¢…ë¥˜ì˜ í† í°ì¸ì§€(ì§€ê¸ˆì˜ ê²½ìš°ì—” JWT), ì–´ë–¤ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ Signí• ì§€ ì •ì˜í•œë‹¤.
    - JSON Web Tokenì´ë¼ëŠ” ì´ë¦„ì— ê±¸ë§ê²Œ JSON í¬ë§· í˜•íƒœë¡œ ì •ì˜ë˜ì–´ ìˆë‹¤.
        
        ```json
        {
          "alg": "HS256",
          "typ": "JWT"
        }
        ```
        
    - ë‹¨ë°©í–¥ ì•”í˜¸í™”
    
    <img src="https://github.com/quokkavely/quokkavely.github.io/assets/165968530/0dfa5e69-7d56-4cba-8b66-c3db822d5f97" width=400>
    
    ì„œë²„ì—ì„œëŠ” ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì‹œê·¸ë‹ˆì²˜ë¡œ í™•ì¸í•œë‹¤  â†’ ì‹œê·¸ë‹ˆì²˜ê°€ ê²€ì¦ì˜ ëŒ€ìƒì´ë‹¤ ,
    
    JWTì˜ í—¤ë”ì™€ í”Œë ˆì´ ë¡œë“œëŠ” í•´ì‹œí•¨ìˆ˜ ê²€ì¦ê³¼ì •ì—ì„œ ê±¸ëŸ¬ì§
    
    ë‘ê°€ì§€ ë°ì´í„°ë¥¼ ë³µí˜¸í™”í•˜ë”ë¼ë„ ë³´í†µ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ë³´ë‚¼ë•Œ í—¤ë”ì— ë‹´ì•„ì„œ ë³´
    
2. Payload
    
    ```json
    {
      "sub": "someInformation",
      "name": "phillip",
      "iat": 151623391
    }
    ```
    
    - Payloadì—ëŠ” ì„œë²„ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìì˜ ì •ë³´ê°€ ë‹´ê²¨ ìˆë‹¤.
    - ì–´ë–¤ ì •ë³´ì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ì— ëŒ€í•œ ê¶Œí•œì„ ë‹´ì„ ìˆ˜ë„ ìˆê³ , ì‚¬ìš©ìì˜ ì´ë¦„ ë“± í•„ìš”í•œ ë°ì´í„°ë¥¼ ë‹´ì„ ìˆ˜ ìˆë‹¤.
    - PayloadëŠ” ë‹¤ìŒìœ¼ë¡œ ì„¤ëª…í•  Signatureë¥¼ í†µí•´ ìœ íš¨ì„±ì´ ê²€ì¦ë  ì •ë³´ì´ê¸´ í•˜ì§€ë§Œ, ë¯¼ê°í•œ ì •ë³´ëŠ” ë‹´ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤. (ì†ì‰½ê²Œ ì½”ë”© í•  ìˆ˜ ìˆê¸° ë•Œë¬¸)
    - ì²« ë²ˆì§¸ ë¶€ë¶„ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ìœ„ JSON ê°ì²´ë¥¼ base64ë¡œ ì¸ì½”ë”©í•˜ë©´ JWTì˜ ë‘ ë²ˆì§¸ ë¸”ë¡ì´ ì™„ì„±ë©ë‹ˆë‹¤.

1. Signature
    - base64ë¡œ ì¸ì½”ë”© ëœ ì²« ë²ˆì§¸, ê·¸ë¦¬ê³  ë‘ ë²ˆì§¸ ë¶€ë¶„ì´ ì™„ì„±ë˜ì—ˆë‹¤ë©´, Signatureì—ì„œëŠ” ì›í•˜ëŠ” ë¹„ë°€ í‚¤(Secret Key)ì™€ Headerì—ì„œ ì§€ì •í•œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ Headerì™€ Payloadì— ëŒ€í•´ì„œ ë‹¨ë°©í–¥ ì•”í˜¸í™”ë¥¼ ìˆ˜í–‰í•œë‹¤.
    - ì´ë ‡ê²Œ ì•”í˜¸í™”ëœ ë©”ì‹œì§€ëŠ” í† í°ì˜ ìœ„ë³€ì¡° ìœ ë¬´ë¥¼ ê²€ì¦í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤.
    - ì˜ˆë¥¼ ë“¤ì–´, ë§Œì•½ HMAC SHA256 ì•Œê³ ë¦¬ì¦˜(ì•”í˜¸í™” ë°©ë²• ì¤‘ í•˜ë‚˜)ì„ ì‚¬ìš©í•œë‹¤ë©´ SignatureëŠ” ì•„ë˜ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ìƒì„±ë¨
        
        ```json
        HMACSHA256(base64UrlEncode(header) + '.' + base64UrlEncode(payload), secret);
        ```
        

### JWT ì‚¬ìš© ì˜ˆì‹œ

JWTëŠ” ê¶Œí•œ ë¶€ì—¬ì— ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

ìƒˆë¡œ ë‹¤ìš´ë¡œë“œí•œ `A`ë¼ëŠ” ì•±ì´ Gmailê³¼ ì—°ë™ë˜ì–´ ì´ë©”ì¼ì„ ì½ì–´ì™€ì•¼ í•œë‹¤ê³  ìƒê°í•´ ë´…ì‹œë‹¤.

ì´ ê²½ìš°, ì‚¬ìš©ìëŠ”

1. Gmail ì¸ì¦ì„œë²„ì— ë¡œê·¸ì¸ ì •ë³´(ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
2. ì¸ì¦ì— ì„±ê³µí•  ê²½ìš°, JWTë¥¼ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
3. A ì•±ì€ JWTë¥¼ ì‚¬ìš©í•´ í•´ë‹¹ ì‚¬ìš©ìì˜ ì´ë©”ì¼ì„ ì½ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í† í° ê¸°ë°˜ ì¸ì¦ ì ˆì°¨

1. í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹´ì•„ ë¡œê·¸ì¸ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
2. ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚¼ ì•”í˜¸í™”ëœ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - Access Tokenê³¼ Refresh Tokenì„ ëª¨ë‘ ìƒì„±í•©ë‹ˆë‹¤.
        - í† í°ì— ë‹´ê¸¸ ì •ë³´(Payload)ëŠ” ì‚¬ìš©ìë¥¼ ì‹ë³„í•  ì •ë³´, ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ ë“±ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - Refresh Token ì´ìš©í•´ ìƒˆë¡œìš´ Access Tokenì„ ìƒì„±í•  ê²ƒì´ë¯€ë¡œ ë‘ ì¢…ë¥˜ì˜ í† í°ì´ `ê°™ì€ ì •ë³´ë¥¼ ë‹´ì„ í•„ìš”`ëŠ” ì—†ìŠµë‹ˆë‹¤.
3. í† í°ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•˜ë©´, í´ë¼ì´ì–¸íŠ¸ëŠ” í† í°ì„ ì €ì¥í•©ë‹ˆë‹¤.
    - ì €ì¥í•˜ëŠ” ìœ„ì¹˜ëŠ” Local Storage, Session Storage, Cookie ë“±ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. í´ë¼ì´ì–¸íŠ¸ê°€ HTTP Header(Authorization Header) ë˜ëŠ” ì¿ í‚¤ì— í† í°ì„ ë‹´ì•„ requestë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
    - Bearer authenticationì„ ì´ìš©í•©ë‹ˆë‹¤. ì°¸ê³  [ë§í¬1(ìš”ì•½)](https://learning.postman.com/docs/sending-requests/authorization/#bearer-token), [ë§í¬2(ìƒì„¸)](https://tools.ietf.org/html/rfc6750)
5. ì„œë²„ëŠ” í† í°ì„ ê²€ì¦í•˜ì—¬ "ì•„ ìš°ë¦¬ê°€ ë°œê¸‰í•´ ì¤€ í† í°ì´ ë§ë„¤!"ë¼ëŠ” íŒë‹¨ì´ ë  ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•œ í›„ ì‘ë‹µì„ ë³´ë‚´ì¤€ë‹¤.

### ì¥ë‹¨ì 

### JWTë¥¼ í†µí•œ ì¸ì¦ì˜ ì¥ì 

1. **ìƒíƒœë¥¼ ìœ ì§€í•˜ì§€ ì•Šê³ (Stateless), í™•ì¥ì— ìš©ì´í•œ(Scalable) ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í•˜ê¸° ìš©ì´í•˜ë‹¤.**
    - ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ì €ì¥í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤. (í† í°ì´ ì •ìƒì ìœ¼ë¡œ ê²€ì¦ë˜ëŠ”ì§€ë§Œ íŒë‹¨í•©ë‹ˆë‹¤)
    - í´ë¼ì´ì–¸íŠ¸ëŠ” requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ í† í°ì„ í—¤ë”ì— í¬í•¨ì‹œí‚¤ë©´ ëœë‹¤
        - ì—¬ëŸ¬ ëŒ€ì˜ ì„œë²„ë¥¼ ì´ìš©í•œ ì„œë¹„ìŠ¤ë¼ë©´ í•˜ë‚˜ì˜ í† í°ìœ¼ë¡œ ì—¬ëŸ¬ ì„œë²„ì—ì„œ ì¸ì¦ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— JWTë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì´ë‹¤.
        
        ë§Œì•½ì— ì„¸ì…˜ ë°©ì‹ì´ë¼ë©´ ëª¨ë“  ì„œë²„ê°€ í•´ë‹¹ ì‚¬ìš©ìì˜ ì„¸ì…˜ ì •ë³´ë¥¼ ê³µìœ í•˜ê³  ìˆì–´ì•¼ í•œë‹¤.
        
2. **í´ë¼ì´ì–¸íŠ¸ê°€ requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ ìê²© ì¦ëª… ì •ë³´ë¥¼ ì „ì†¡í•  í•„ìš”ê°€ ì—†ë‹¤.**
    - HTTP Basic ê°™ì€ ì¸ì¦ ë°©ì‹ì€ requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ ìê²© ì¦ëª… ì •ë³´ë¥¼ í¬í•¨í•´ì•¼ í•˜ì§€ë§Œ JWTì˜ ê²½ìš° í† í°ì´ ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” í•œ ë²ˆì˜ ì¸ì¦ë§Œ ìˆ˜í–‰í•˜ë©´ ëœë‹¤.
3. **ì¸ì¦ì„ ë‹´ë‹¹í•˜ëŠ” ì‹œìŠ¤í…œì„ ë‹¤ë¥¸ í”Œë«í¼ìœ¼ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ìš©ì´í•˜ë‹¤**
    - ì‚¬ìš©ìì˜ ìê²© ì¦ëª… ì •ë³´ë¥¼ ì§ì ‘ ê´€ë¦¬í•˜ì§€ ì•Šê³ , Github, Google ë“±ì˜ ë‹¤ë¥¸ í”Œë«í¼ì˜ ìê²© ì¦ëª… ì •ë³´ë¡œ ì¸ì¦í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥
    - í† í° ìƒì„±ìš© ì„œë²„ë¥¼ ë§Œë“¤ê±°ë‚˜, ë‹¤ë¥¸ íšŒì‚¬ì—ì„œ í† í° ê´€ë ¨ ì‘ì—…ì„ ë§¡ê¸°ëŠ” ê²ƒ ë“± ë‹¤ì–‘í•œ í™œìš©ì´ ê°€ëŠ¥
4. **ê¶Œí•œ ë¶€ì—¬ì— ìš©ì´í•˜ë‹¤**
    - í† í°ì˜ Payload(ë‚´ìš©ë¬¼) ì•ˆì— í•´ë‹¹ ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” ê²ƒì´ ìš©ì´í•˜ë‹¤

### JWTë¥¼ í†µí•œ ì¸ì¦ì˜ ë‹¨ì 

1. **PayloadëŠ” ë””ì½”ë”©ì´ ìš©ì´í•˜ë‹¤**
    - PayloadëŠ” base64ë¡œ ì¸ì½”ë”© ë˜ê¸° ë•Œë¬¸ì— í† í°ì„ íƒˆì·¨í•˜ì—¬ Payloadë¥¼ ë””ì½”ë”©í•˜ë©´ í† í° ìƒì„± ì‹œ ì €ì¥í•œ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ Payloadì—ëŠ” ë¯¼ê°í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.
2. **í† í°ì˜ ê¸¸ì´ê°€ ê¸¸ì–´ì§€ë©´ ë„¤íŠ¸ì›Œí¬ì— ë¶€í•˜ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤**
    - í† í°ì— ì €ì¥í•˜ëŠ” ì •ë³´ì˜ ì–‘ì´ ë§ì•„ì§ˆìˆ˜ë¡ í† í°ì˜ ê¸¸ì´ëŠ” ê¸¸ì–´ì§„ë‹¤.
        
        ë”°ë¼ì„œ requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ ê¸¸ì´ê°€ ê¸´ í† í°ì„ í•¨ê»˜ ì „ì†¡í•˜ë©´ ë„¤íŠ¸ì›Œí¬ì— ë¶€í•˜ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤.
        
3. **í† í°ì€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•ŠëŠ”ë‹¤.**
    - ì¦‰ í•œ ë²ˆ ìƒì„±ëœ í† í°ì€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í† í° ë§Œë£Œ ì‹œê°„ì„ ë°˜ë“œì‹œ ì¶”ê°€í•´ì•¼ í•œë‹¤.
    - ë˜í•œ í† í°ì´ íƒˆì·¨ëœ ê²½ìš° í† í°ì˜ ê¸°í•œì´ ë§Œë£Œë  ë•Œê¹Œì§€ í† í° íƒˆì·¨ìê°€ í•´ë‹¹ í† í°ì„ ì •ìƒì ìœ¼ë¡œ ì´ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§Œë£Œ ì‹œê°„ì„ ë„ˆë¬´ ê¸¸ê²Œ ì„¤ì •í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

# ì»¤í”¼ ì£¼ë¬¸ì• í”Œë¦¬ì¼€ì´ì…˜ì— JWTì ìš©

## ì‚¬ì „ì‘ì—… (ì˜ì¡´ì„±ì¶”ê°€, ë¹„ë°€ë²ˆí˜¸ê´€ë ¨ í•„ë“œ ì¶”ê°€)

### 1. ì˜ì¡´ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

```java
	// Spring Securityë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ spring-boot-starter-securityë¥¼ ì¶”ê°€
	implementation 'org.springframework.boot:spring-boot-starter-security'

  // (2) JWT ê¸°ëŠ¥ì„ ìœ„í•œ jjwt ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
	runtimeOnly	'io.jsonwebtoken:jjwt-jackson:0.11.5'
```

### 2. JWT ì ìš© ì „ Spring Securityë¥¼ ì´ìš©í•´ì„œ ìµœì†Œí•œì˜ ë³´ì•ˆêµ¬ì„±

```java
package com.springboot.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http)throws Exception{
        http
                .headers().frameOptions().sameOrigin()
                //ë™ì¼ ì¶œì²˜ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” requestë§Œ í˜ì´ì§€ ë Œë”ë§ì„ í—ˆìš©
                .and()
                .csrf().disable() //ë°°í¬í•  ë•Œë§Œ ë³€ê²½í•˜ë©´ ë¨.
                .cors(withDefaults()) //corsConfigurationSourceë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ Beanì„ ì´ìš©
                //CORSë¥¼ ì²˜ë¦¬í•˜ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ CorsFilterë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì¸ë° 
                // CorsConfigurationSource Beanì„ ì œê³µí•¨ìœ¼ë¡œì¨ CorsFilterë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.
                .formLogin().disable() //í¼ë¡œê·¸ì¸ ì‚¬ìš©í•˜ì§€ ì•Šê²Ÿë‹¤.
                .httpBasic().disable()
                .authorizeHttpRequests(authorize -> authorize.anyRequest().permitAll());
                //ì¸ì¦ì¸ê°€ í›„ ë³€ê²½ì˜ˆì •
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    //Corsì„¤ì • ì¶”ê°€, corsConfigurationSourceë¥¼ ë¹ˆìœ¼ë¡œ ë™ë¡
    @Bean
    CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
            //ëª¨ë“  ì¶œì²˜(Origin)ì— ëŒ€í•´ ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ì˜ HTTP í†µì‹ ì„ í—ˆìš©í•˜ë„ë¡ ì„¤ì •
        configuration.setAllowedMethods(Arrays.asList("GET","POST","PATCH","DELETE"));
            //íŒŒë¼ë¯¸í„°ë¡œ ì§€ì •í•œ HTTP Methodì— ëŒ€í•œ HTTP í†µì‹ ì„ í—ˆìš©
        UrlBasedCorsConfigurationSource source  = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**",configuration);
       return source;

    }
}

```



### Password í•„ë“œì¶”ê°€

1. MemberDto.Post
    
    ```java        
     @NotBlank
            private String password;
    ```
    
2. Member -password, Authorize ì¶”ê°€
    
    ```java
    @Column(length = 100, nullable = false)
        private String password;

    @ElementCollection(fetch = FetchType.EAGER)
        private List<String>role = new ArrayList<>();
    ```
    
3. MemberService
    
    ```java
    @Transactional
    @Service
    public class MemberService {
        private final MemberRepository memberRepository;
        private final ApplicationEventPublisher publisher;
        
        // ì¶”ê°€
        private final PasswordEncoder passwordEncoder;
        private final JwtAuthorityUtils jwtAuthorityUtils;
        
        public MemberService(MemberRepository memberRepository,
                             ApplicationEventPublisher publisher, PasswordEncoder passwordEncoder, JwtAuthorityUtils jwtAuthorityUtils) {
            this.memberRepository = memberRepository;
            this.publisher = publisher;
          
          //ì¶”ê°€
            this.passwordEncoder = passwordEncoder;
            this.jwtAuthorityUtils = jwtAuthorityUtils;
        }
    
    public Member createMember(Member member) {
            verifyExistsEmail(member.getEmail());
    
            //íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” í•„ìš” - ë‹¨ë°©í–¥ ì•”í˜¸
            String encrypedPassword =  passwordEncoder.encode(member.getPassword());
            member.setPhone(encrypedPassword);
    
            //DBì— UserRoles ì €ì¥
            List<String> roles = jwtAuthorityUtils.createRoles(member.getEmail());
            member.setRoles(roles);
    
            Member savedMember = memberRepository.save(member);
    
         
            publisher.publishEvent(new MemberRegistrationApplicationEvent(this, savedMember));
            return savedMember;
        }
    ```
    

ë©±ë“±ì„±ì„ ê°€ì§€ëŠ” ê²ƒ. (ì„œë²„ì— ë™ì¼í•œ ìš”ì²­ì„ í•˜ëŠ”ì§€ë¥¼ ë´ì•¼ í•¨.= GET,POST,DELETE

1. **JwtAuthorityUtils í´ë˜ìŠ¤ ìƒì„±**
    
    ```java
    package com.springboot.auth.utils;
    
    import org.springframework.beans.factory.annotation.Value;
    import org.springframework.security.core.authority.AuthorityUtils;
    import org.springframework.security.core.GrantedAuthority;
    import org.springframework.security.core.authority.SimpleGrantedAuthority;
    import org.springframework.stereotype.Component;
    import java.util.List;
    import java.util.stream.Collectors;
    
    @Component
    public class JwtAuthorityUtils {
        @Value("${mail.address.admin}")
        private String adminMailAddress;
    
        private final List<GrantedAuthority> ADMIN_ROLES
                = AuthorityUtils.createAuthorityList("ROLE_ADMIN","ROLEUSER");
    
        private final List<GrantedAuthority>USER_ROLES
                = AuthorityUtils.createAuthorityList("ROLE_USER");
        private final List<String> ADMIN_ROLES_STRING = List.of("ADMIN","USER");
        private final List<String> USER_ROLES_STRING = List.of("USER");
    
        public List<GrantedAuthority> createAutrorities(String email){
            if(email.equals(adminMailAddress)){
                return ADMIN_ROLES;
            }
            return USER_ROLES;
        }
    
        public List<GrantedAuthority>createAuthority(List<String>roles){
            return roles.stream()
                    .map(role-> new SimpleGrantedAuthority("ROLE_"+role))
                    .collect(Collectors.toList());
        }
        public List<String>createRoles(String email){
            if(email.equals(adminMailAddress)){
                return ADMIN_ROLES_STRING;
            }
            return USER_ROLES_STRING;
        }
    }
    
    ```
    

## ë¡œê·¸ì¸ ì¸ì¦

ì‚¬ìš©ìì˜ Username(ì´ë©”ì¼ ì£¼ì†Œ)ê³¼ Passwordë¡œ ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•˜ë©´ **ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìì—ê²Œ JWTë¥¼ ìƒì„± ë° ë°œê¸‰í•˜ê¸°**

### ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ì¸ì¦ ì„±ê³µ í›„, JWTê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬ë˜ëŠ” ê³¼ì •

1. í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ ì¸¡ì— ë¡œê·¸ì¸ ì¸ì¦ ìš”ì²­(Username/Passwordë¥¼ ì„œë²„ ì¸¡ì— ì „ì†¡)
2. ë¡œê·¸ì¸ ì¸ì¦ì„ ë‹´ë‹¹í•˜ëŠ” Security Filter(`JwtAuthenticationFilter`)ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ ìˆ˜ì‹ 
3. Security Filterê°€ ìˆ˜ì‹ í•œ ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ë¥¼ AuthenticationManagerì—ê²Œ ì „ë‹¬í•´ ì¸ì¦ ì²˜ë¦¬ë¥¼ ìœ„ì„
4. AuthenticationManagerê°€ **Custom UserDetailsService**(`MemberDetailsService`)ì—ê²Œ ì‚¬ìš©ìì˜ UserDetails ì¡°íšŒë¥¼ ìœ„ì„
5. **Custom UserDetailsService**(`MemberDetailsService`)ê°€ ì‚¬ìš©ìì˜ í¬ë¦¬ë´ì…œì„ DBì—ì„œ ì¡°íšŒí•œ í›„, AuthenticationManagerì—ê²Œ ì‚¬ìš©ìì˜ **UserDetails**ë¥¼ ì „ë‹¬
6. AuthenticationManagerê°€ **ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ì™€ UserDetailsì˜ ì •ë³´ë¥¼ ë¹„êµí•´ ì¸ì¦ ì²˜ë¦¬**
7. JWT ìƒì„± í›„, í´ë¼ì´ì–¸íŠ¸ì˜ ì‘ë‹µìœ¼ë¡œ ì „ë‹¬

4ë²ˆê³¼ 6ë²ˆì€ Spring Securityì˜ AuthenticationManagerê°€ ëŒ€ì‹  ì²˜ë¦¬í•´ì¤Œ

### 1ï¸âƒ£ Custom UserDetailsService êµ¬í˜„

```java
package com.springboot.auth.userDetails;

import com.springboot.auth.utils.JwtAuthorityUtils;
import com.springboot.exception.BusinessLogicException;
import com.springboot.exception.ExceptionCode;
import com.springboot.member.entity.Member;
import com.springboot.member.repository.MemberRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import java.util.Collection;
import java.util.Optional;

public class MemberDetailsService implements UserDetailsService {
    private final MemberRepository memberRepository;
    private final JwtAuthorityUtils authorityUtils;

    public MemberDetailsService(MemberRepository memberRepository, JwtAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.authorityUtils = authorityUtils;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        //DBì—ì„œ ì¡°íšŒ
        Optional<Member> optionalMember = memberRepository.findByEmail(username);
        Member findMember = optionalMember.orElseThrow(()-> new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND));
        //MemberëŠ” DBì—ì„œ ê°€ì ¸ì˜¨ ê²ƒì´ë¯€ë¡œ - ì•”í˜¸í™” ë˜ì–´ìˆë‹¤.
        return new MemberDetails(findMember);
    }

    //Memberë¥¼ í™•ì¥
    private final class MemberDetails extends Member implements UserDetails{
        //MemberDetailsëŠ” ìƒì„±ì -> ì´ê±´ ë°”ë¡œ ìœ„ì˜ ë°˜í™˜ëœ ê°’ 
        // = DBì—ì„œ ê°€ì ¸ì˜¨ ê²ƒ.  = ì•”í˜¸í™” ë˜ì–´ìˆìŒ.
        
        MemberDetails(Member member){
            setMemberId(member.getMemberId());
            setEmail(member.getEmail());
            setPassword(member.getPassword());
            setRoles(member.getRoles());
        }

        @Override
        public Collection<? extends GrantedAuthority> getAuthorities() {
            return authorityUtils.createAuthority(this.getRoles());
        }

        @Override
        public String getUsername() {
            return this.getEmail();
        }

        @Override
        public boolean isAccountNonExpired() {
            return true;  //falseì—ì„œ ìˆ˜ì •
        }

        @Override
        public boolean isAccountNonLocked() {
            return true; //falseì—ì„œ ìˆ˜ì •
        }

        @Override
        public boolean isCredentialsNonExpired() {
            return true; //falseì—ì„œ ìˆ˜ì •
        }

        @Override
        public boolean isEnabled() {
            return true; //falseì—ì„œ ìˆ˜ì •
        }
    }
}

```

### 2ï¸âƒ£ ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ ì—­ì§ë ¬í™”(Deserialization)ë¥¼ ìœ„í•œ LoginDTO í´ë˜ìŠ¤ ìƒì„±

í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•œ Username/Password ì •ë³´ë¥¼ Security Filterì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì—­ì§ë ¬í™”(Deserialization) í•˜ê¸° ìœ„í•œ DTO í´ë˜ìŠ¤ì´ë‹¤.

```java
package com.springboot.auth.dto;

import lombok.Getter;

@Getter //dtoì—ëŠ” Getter í•„ìˆ˜.
public class LoginDto {
    private String username;
    private String password;
}

```

### 3ï¸âƒ£ JWTë¥¼ ìƒì„±í•˜ëŠ” JwtTokenizer êµ¬í˜„

1. **JwtTokenizer**
    
    ```java
    package com.springboot.auth.jwt;
    
    import lombok.Getter;
    import org.springframework.beans.factory.annotation.Value;
    
    public class JwtTokenizer {
        @Getter
        @Value("${jwt.key}") //ymlì— ì €ì¥ í•„ìˆ˜
        private String secretKey;
        @Getter
        @Value("${jwt.access-token-expiration-minute}") //ymlì— ì €ì¥ í•„ìˆ˜
        private int accessTokenExpirationMinutes;
        @Getter
        @Value("${jwt.refresh-token-expiration-minute}") //ymlì— ì €ì¥ í•„ìˆ˜
        private int refreshTokenExpirationMinutes;
    
    }
    
    ```
    
2. **application.yml**
    - ${JWT_SECRET_KEY}ëŠ” ë‹¨ìˆœí•œ ë¬¸ìì—´ì´ ì•„ë‹ˆë¼ OSì˜ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ ì½ì–´ì˜¤ëŠ” ì¼ì¢…ì˜ í‘œí˜„ì‹
        
        <img src="https://github.com/user-attachments/assets/861e454b-b885-43c9-9540-c1264acd8ccc" width=400/>
        
3. **ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜ í¸ì§‘ (ì‹œìŠ¤í…œí™˜ê²½ë³€ìˆ˜í¸ì§‘- í™˜ê²½ë³€ìˆ˜ - ì‹œìŠ¤í…œë³€ìˆ˜ ì¶”ê°€)**
    - JWTì˜ ì„œëª…ì— ì‚¬ìš©ë˜ëŠ” Secret Key ì •ë³´ëŠ” ë¯¼ê°í•œ(sensitive) ì •ë³´ì´ë¯€ë¡œ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ì˜ ë³€ìˆ˜ë¡œ ë“±ë¡
        
        <img src="https://github.com/user-attachments/assets/601e435e-e519-47c8-b675-3963903480c6" width=400/>
        

### 4ï¸âƒ£ ë¡œê·¸ì¸ ì¸ì¦ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” Custom Security Filter êµ¬í˜„

JwtAuthenticationFilter

```java
//UsernamePasswordAuthenticationfilterë¥¼ êµì²´í•˜ëŠ” ê²ƒ.
public class JwtAuthenticationFilter extends UsernamePasswordAuthenticationFilter {
    //í¼ ë¡œê·¸ì¸ ë°©ì‹ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë””í´íŠ¸ Security Filterë¡œì¨,
    //í¼ ë¡œê·¸ì¸ì´ ì•„ë‹ˆë”ë¼ë„ Username/Password ê¸°ë°˜ì˜ ì¸ì¦ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´
    // UsernamePasswordAuthenticationFilterë¥¼ í™•ì¥í•´ì„œ êµ¬í˜„

    private final AuthenticationManager authenticationManager;
    // ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´(Username/Password)ë¥¼ ì „ë‹¬ë°›ì•„ UserDetailsServiceì™€ ì¸í„°ë™ì…˜ í•œ ë’¤ ì¸ì¦ ì—¬ë¶€ë¥¼ íŒë‹¨
    private final JwtTokenizer jwtTokenizer;
    //í´ë¼ì´ì–¸íŠ¸ê°€ ì¸ì¦ì— ì„±ê³µí•  ê²½ìš°, JWTë¥¼ ìƒì„± ë° ë°œê¸‰

    public JwtAuthenticationFilter(AuthenticationManager authenticationManager, JwtTokenizer jwtTokenizer) {
        this.authenticationManager = authenticationManager;
        this.jwtTokenizer = jwtTokenizer;
    }

    @SneakyThrows //try-catchë¥¼ ëŒ€ì²´
    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response){
        //í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•œ Usernameê³¼ Passwordë¥¼ DTO í´ë˜ìŠ¤ë¡œ ì—­ì§ë ¬í™”(Deserialization) í•˜ê¸° ìœ„í•´ ObjectMapper ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±
        ObjectMapper objectMapper = new ObjectMapper();
        LoginDto loginDto = objectMapper.readValue(request.getInputStream(), LoginDto.class);
        //ServletInputStreamì„ LoginDto í´ë˜ìŠ¤ì˜ ê°ì²´ë¡œ ì—­ì§ë ¬í™”í•œë‹¤.

        // token ë§Œë“œëŠ” ì´ìœ  UsernamePasswordAuthenticationToken ì„ ëŒ€ì²´í•˜ëŠ” ê²ƒ, êµ¬í˜„ì²´ë„ ì‹¤ì œë¡œ ë§Œë“¤ì–´ì ¸ìˆìŒ
        UsernamePasswordAuthenticationToken authenticationToken
                = new UsernamePasswordAuthenticationToken(loginDto.getUsername(),loginDto.getPassword());

        return authenticationManager.authenticate(authenticationToken);

    }

    protected void successfulAuthentication(HttpServletRequest request,
                                            HttpServletResponse response,
                                            FilterChain chain,
                                            Authentication authentication) throws ServletException, IOException {
        Member member = (Member) authentication.getPrincipal();

        //token ë§Œë“¤ê¸°
        String accessToken= delegateAceessToken(member);
        String refreshToken = delegateRefreshToken(member);
        response.setHeader("Authorization", "Bearer " + accessToken);
        response.setHeader("Refresh", refreshToken);
        this.getSuccessHandler().onAuthenticationSuccess(request,response,authentication);
    }

    protected String delegateAceessToken(Member member){
        Map<String,Object> claims = new HashMap<>();
        claims.put("username",member.getEmail());
        claims.put("roles", member.getRoles());
                //tokenì•ˆì— ì ˆëŒ€ ë¹„ë°€ë²ˆí˜¸ ë„£ì§€ì•ŠìŒ, playload ë””ì½”ë”©ì€ ì—„ì²­ì‰½ë‹¤.
        String subject = member.getEmail();
        Date expiration = jwtTokenizer.getTokenExpiration(jwtTokenizer.getAccessTokenExpirationMinutes());
        String base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey());
        String accessToken = jwtTokenizer.generateAccessToken(claims, subject, expiration, base64EncodedSecretKey);
        return accessToken;

        //ë¯¼ê°í•œ ì •ë³´ëŠ” ì ˆëŒ€ í‰ë¬¸í™” í•˜ë©´ ì•ˆë¨.
        //ìŠ¤í”„ë§ì—ì„œ ì¸ì¦ì¸ê°€ëŠ” ë¬´ì¡°ê±´ securityì‚¬ìš©
    }

    protected String delegateRefreshToken(Member member) {

        String subject = member.getEmail();
        Date expiration = jwtTokenizer.getTokenExpiration(jwtTokenizer.getRefreshTokenExpirationMinutes());
        String base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey());
        String refreshToken = jwtTokenizer.generateRefreshToken(subject, expiration, base64EncodedSecretKey);
        return refreshToken;
    }
    //ì‹¤íŒ¨í–ˆì„ë• ìë™ìœ¼ë¡œ ë“±ë¡ ëœë‹¤.
    //ì„±ê³µí–ˆì„ë•ŒëŠ” ì„±ê³µí•˜ê³  ë‚˜ì„œ ìˆ˜í–‰í•  ì‘ì—…ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ëª…ì‹ì ìœ¼ë¡œ ë„£ì–´ì£¼ì–´ì•¼

}
```

### 5ï¸âƒ£ Custom Filter ì¶”ê°€ë¥¼ ìœ„í•œ SecurityConfiguration ì„¤ì • ì¶”ê°€

SecurityConfiguration

```java
@Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;

    public SecurityConfiguration(JwtTokenizer jwtTokenizer) {
        this.jwtTokenizer = jwtTokenizer;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http)throws Exception{
        http
                .headers().frameOptions().sameOrigin()
                .and()
                .csrf().disable() //ë°°í¬í•  ë•Œë§Œ ë³€ê²½í•˜ë©´ ë¨.
                .cors(withDefaults())
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                .formLogin().disable() //í¼ë¡œê·¸ì¸ ì‚¬ìš©í•˜ì§€ ì•Šê²Ÿë‹¤.
                .httpBasic().disable()
                .apply(new CustomFilterConfigurer())
                .and()
	              .authorizeHttpRequests(authorize -> authorize.anyRequest().permitAll());
         
        return http.build();

    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    //Corsì„¤ì • ì¶”ê°€, corsConfigurationSourceë¥¼ ë¹ˆìœ¼ë¡œ ë™ë¡
    @Bean
    CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST","PATCH","DELETE"));
        UrlBasedCorsConfigurationSource source  = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**",configuration);
       return source;
    }

    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer,HttpSecurity>{
            //AbstractHttpConfigurerë¥¼ ìƒì†í•´ì„œ Custom Configurerë¥¼ êµ¬í˜„
            //AbstractHttpConfigurerë¥¼ ìƒì†í•˜ëŠ” íƒ€ì…ê³¼ HttpSecurityBuilderë¥¼ ìƒì†í•˜ëŠ” íƒ€ì…ì„ ì œë„ˆë¦­ íƒ€ì…ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
        @Override  //configure() ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•´ì„œ Configurationì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•
        public void configure(HttpSecurity builder){
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);
            //getSharedObject()ë¥¼ í†µí•´ì„œ Spring Securityì˜ ì„¤ì •ì„ êµ¬ì„±í•˜ëŠ” SecurityConfigurer ê°„ì— ê³µìœ ë˜ëŠ” ê°ì²´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            //  JwtAuthenticationFilterì—ì„œ ì‚¬ìš©ë˜ëŠ” AuthenticationManagerì™€ JwtTokenizerë¥¼ DIí•´ì¤€ë‹¤.

            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login"); //ì—†ì„ë•ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì ìš©ë¨ ("/login)

            builder.addFilter(jwtAuthenticationFilter);
            // addFilter() ë©”ì„œë“œë¥¼ í†µí•´ JwtAuthenticationFilterë¥¼ Spring Security Filter Chainì— ì¶”ê°€
        }
    }
}
```

ì˜¨ì „íˆ ì´í•´í•˜ê¸° í˜ë“¤ê¸° ë•Œë¬¸ì— ì´ë ‡ê²Œ ì“°ëŠ” êµ¬ë‚˜ í•˜ê³  ì™¸ìš°ê¸°â€¦.?

### ë¡œê·¸ì¸ ì‹œë„

1. íšŒì›ê°€ì…
    
    <img src="https://github.com/user-attachments/assets/ad050956-5c1f-4309-af72-0ce76493dc6b"/>
    
2. ë¡œê·¸ì¸
    
    <img src="https://github.com/user-attachments/assets/f015206f-3e9e-461a-81f2-ebc0df32fa9f"/>
    
3. ë¹„ë°€ë²ˆí˜¸ ì˜ëª» ì…ë ¥ì‹œ ì—ëŸ¬ ë°œìƒ
    
    `HttpStatus.UNAUTHORIZED(401)` ìƒíƒœ ì½”ë“œëŠ” ì¸ì¦ì— ì‹¤íŒ¨í•  ê²½ìš° ì „ë‹¬í•  ìˆ˜ ìˆëŠ” HTTP status
    
    â†’ ì¶”ê°€ ê°œì„  í•„ìš”
    

## ë¡œê·¸ì¸ ì¸ì¦ ì„±ê³µ ë° ì‹¤íŒ¨ì— ë”°ë¥¸ ì¶”ê°€ ì²˜ë¦¬

### 1ï¸âƒ£ AuthenticationSuccessHandler êµ¬í˜„

```java
@Slf4j
public class MemberAuthenticationSuccessHandler implements AuthenticationSuccessHandler {
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException{
        log.info("# Authenticated successfully!");
    }
}

```

### 2ï¸âƒ£ AuthenticationFailureHandler êµ¬í˜„

```java

//component ì—†ëŠ”ê±´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ì¡ì•„ì£¼ëŠ” ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì—,
//ì¸ì¦ì„ ë‹´ë‹¹í•˜ëŠ” JwtAuthenticationFilterì— ì´ ê°ì²´ë¥¼ ì¶”ê°€í•´ì£¼ì–´ì•¼ í•¨.
@Slf4j
public class MemberAuthenticationFailureHandler implements AuthenticationFailureHandler {
    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
        //ë³´í†µ ë¡œê¹… ê¸°ëŠ¥ í¬í•¨
        log.info("Authenticated failed");
        log.error("Authenticated failed", exception.getMessage());
        sendErrorResponse(response);

    }

    private void sendErrorResponse(HttpServletResponse response) throws IOException {
        Gson gson = new Gson();
        ErrorResponse errorResponse = ErrorResponse.of(HttpStatus.UNAUTHORIZED);
        //HttpStatus.UNAUTHORIZED ìƒíƒœ ì½”ë“œë¥¼ ì „ë‹¬
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        // Content Typeì´ â€œapplication/jsonâ€ì´ë¼ëŠ” ê²ƒì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë ¤ì¤„ ìˆ˜ ìˆë„ë¡ MediaType.APPLICATION_JSON_VALUEë¥¼ HTTP Headerì— ì¶”ê°€
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        // responseì˜ statusê°€ 401 ì„ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë ¤ì¤„ ìˆ˜ ìˆë„ë¡ HttpStatus.UNAUTHORIZED.value()ì„ HTTP Headerì— ì¶”ê°€
        
        response.getWriter().write(gson.toJson(errorResponse,ErrorResponse.class));
        //Gsonì„ ì´ìš©í•´ ErrorResponse ê°ì²´ë¥¼ JSON í¬ë§· ë¬¸ìì—´ë¡œ ë³€í™˜ í›„, 
        //ì¶œë ¥ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±
    }
}

```

### 3ï¸âƒ£ AuthenticationSuccessHandlerì™€ AuthenticationFailureHandler ì¶”ê°€

 AuthenticationFailureHandler ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ `JwtAuthenticationFilter`ì— ë“±ë¡í•˜ë©´ ë¡œê·¸ì¸ ì¸ì¦ ì‹œ, ë‘ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
  @Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;

    public SecurityConfiguration(JwtTokenizer jwtTokenizer) {
        this.jwtTokenizer = jwtTokenizer;
    }
    
    ...
  
  public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer, HttpSecurity> {
        @Override
        public void configure(HttpSecurity builder) throws Exception {
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login");
            jwtAuthenticationFilter.setAuthenticationSuccessHandler(new MemberAuthenticationSuccessHandler());  // (3) ì¶”ê°€
            jwtAuthenticationFilter.setAuthenticationFailureHandler(new MemberAuthenticationFailureHandler());  // (4) ì¶”ê°€
            builder.addFilter(jwtAuthenticationFilter);
        }
    }
}

```

AuthenticationSuccessHandlerì™€ AuthenticationFailureHandler ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ê°€ ë‹¤ë¥¸ Security Filterì—ì„œ ì‚¬ìš©ì´ ëœë‹¤ë©´ ApplicationContextì— Beanìœ¼ë¡œ ë“±ë¡í•´ì„œ DI ë°›ëŠ” ê²Œ ë§ë‹¤.

ğŸ’¡ í•˜ì§€ë§Œ ì¼ë°˜ì ìœ¼ë¡œ ì¸ì¦ì„ ìœ„í•œ Security Filterë§ˆë‹¤ AuthenticationSuccessHandlerì™€ AuthenticationFailureHandlerì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ê°ê° ìƒì„±í•  ê²ƒì´ë¯€ë¡œ `new` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ ìƒì„±í•´ë„ ë¬´ë°©

### 4ï¸âƒ£ AuthenticationSuccessHandler í˜¸ì¶œ

**JwtAuthenticationFilter(AuthenticationSuccessHandler í˜¸ì¶œ ì½”ë“œ ì¶”ê°€)**

```java
public class JwtAuthenticationFilter extends UsernamePasswordAuthenticationFilter {
    ...
    ...

    @Override
    protected void successfulAuthentication(HttpServletRequest request,
                                            HttpServletResponse response,
                                            FilterChain chain,
                                            Authentication authResult) throws ServletException, IOException {
        Member member = (Member) authResult.getPrincipal();

        String accessToken = delegateAccessToken(member);
        String refreshToken = delegateRefreshToken(member);

        response.setHeader("Authorization", "Bearer " + accessToken);
        response.setHeader("Refresh", refreshToken);

        this.getSuccessHandler().onAuthenticationSuccess(request, response, authResult);  // (1) ì¶”ê°€
    }

    ...
    ...
}

```

## ìê²©ì¦ëª… ë° ê²€ì¦ êµ¬í˜„

í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ JWTë¥¼ ì´ìš©í•´ ìê²© ì¦ëª…ì´ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ request ì „ì†¡ ì‹œ, request headerë¥¼ í†µí•´ ì „ë‹¬ë°›ì€ JWTë¥¼ ì„œë²„ ì¸¡ì—ì„œ ê²€ì¦í•˜ëŠ” ê¸°ëŠ¥

### 1ï¸âƒ£ JWT ê²€ì¦ í•„í„° êµ¬í˜„

```java
package com.springboot.auth.filter;

import com.springboot.auth.jwt.JwtTokenizer;
import com.springboot.auth.utils.JwtAuthorityUtils;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.Map;

// OncePerRequestFilterë¥¼ í™•ì¥í•´ì„œ request ë‹¹ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” Security Filterë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.
//êµ¬í˜„ì²´ë¼ì„œ ìƒì†ë°›ì•„ì„œ êµ¬í˜„í•  ê²ƒ. -í† í°ê³¼ ê´€ë ¨ëœ ì„œë¹„ìŠ¤, ê¶Œí•œì„ ê°€ì ¸ì™€ì•¼ í•¨
public class JwtVerifiedFilter extends OncePerRequestFilter {
    private final JwtTokenizer jwtTokenizer;
    private final JwtAuthorityUtils authorityUtils;

    public JwtVerifiedFilter(JwtTokenizer jwtTokenizer, JwtAuthorityUtils authorityUtils) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        Map<String,Object> claims = verifyJws(request);
          //SecurityContextì•ˆì— ì €ì¥í•´ì£¼ì–´ì•¼ í•¨.
        setAuthenticationToContext(claims);
	        // Authentication ê°ì²´ë¥¼ SecurityContextì— ì €ì¥
        filterChain.doFilter(request,response);
	       // ë‹¤ìŒ(Next) Security Filterë¥¼ í˜¸ì¶œ
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request){
    // íŠ¹ì • ì¡°ê±´ì— ë¶€í•©í•˜ë©´(trueì´ë©´) í•´ë‹¹ Filterì˜ ë™ì‘ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  
    // ë‹¤ìŒ Filterë¡œ ê±´ë„ˆ ë›°ë„ë¡œ ã„±í•´ì¤€ë‹¤. 
        String authorization = request.getHeader("Athorization");
	        //Authorization headerì˜ ê°’ì„ ì–»ì€ í›„
        return authorization == null || !authorization.startsWith("Bearer");
	        //Authorization headerì˜ ê°’ì´ nullì´ê±°ë‚˜ 
	        //Authorization headerì˜ ê°’ì´ â€œBearerâ€ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í•´ë‹¹ Filterì˜ ë™ì‘ì„ ìˆ˜í–‰í•˜ì§€ ì•Šë„ë¡ ì •ì˜
			    // JWTê°€ Authorization headerì— í¬í•¨ë˜ì§€ ì•Šì•˜ë‹¤ë©´ 
			    // JWT ìê²©ì¦ëª…ì´ í•„ìš”í•˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìš”ì²­ì´ë¼ê³  íŒë‹¨í•˜ê³  
			    // ë‹¤ìŒ(Next) Filterë¡œ ì²˜ë¦¬ë¥¼ ë„˜ê¸°ëŠ” ê²ƒ
    
    }

    private Map<String, Object> verifyJws(HttpServletRequest request){
        String jws = request.getHeader("Authorization").replace("Bearer","");
        
        String bas64EncodedSecretKey =jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey());
				// JWT ì„œëª…(Signature)ì„ ê²€ì¦í•˜ê¸° ìœ„í•œ Secret Keyë¥¼ ì–»ëŠ”ë‹¤.
        Map<String,Object>claims = jwtTokenizer.getClaims(jws,bas64EncodedSecretKey).getBody();
        // JWTì—ì„œ Claimsë¥¼ íŒŒì‹± -> getClaims ì•ˆì—ì„œ ê²€ì¦ê¹Œì§€ ì´ë£¨ì–´ì§€ëŠ” ê²ƒ.
        return claims;
    }

    private void setAuthenticationToContext(Map<String,Object>claims){
        String username = (String) claims.get("username");
        List<GrantedAuthority> authorities = authorityUtils.createAuthorities((List)claims.get("roles"));
        Authentication authentication = new UsernamePasswordAuthenticationToken(username,null,authorities);
                //passwordëŠ” ë„£ì§€ ì•ŠëŠ”ë‹¤.ì¤‘ìš”!!
        SecurityContextHolder.getContext().setAuthentication(authentication);

    }
}
```

- **shouldNotFilter()**
    - JWTê°€ Authorization headerì— í¬í•¨ë˜ì§€ ì•Šì•˜ë‹¤ë©´ JWT ìê²©ì¦ëª…ì´ í•„ìš”í•˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìš”ì²­ì´ë¼ê³  íŒë‹¨í•˜ê³  ë‹¤ìŒ(Next) Filterë¡œ ì²˜ë¦¬ë¥¼ ë„˜ê¸°ëŠ” ê²ƒ
    - ë§Œì¼ JWT ìê²© ì¦ëª…ì´ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì¸ë° ì‹¤ìˆ˜ë¡œ JWTë¥¼ í¬í•¨í•˜ì§€ ì•Šì•˜ë‹¤ í•˜ë”ë¼ë„ ì´ ê²½ìš°ì—ëŠ” **Authenticationì´ ì •ìƒì ìœ¼ë¡œ SecurityContextì— ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ Security Filterë¥¼ ê±°ì³ ê²°êµ­ Exceptionì„ ë˜ì§€ê²Œ ë  ê²ƒ**

### 2ï¸âƒ£ SecurityConfiguration ì„¤ì • ì—…ë°ì´íŠ¸

- ì„¸ì…˜ ì •ì±… ì„¤ì • ì¶”ê°€
- JwtVerificationFilter ì¶”ê°€

**SecurityConfiguration**

```java
@Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;
    private final JwtAuthorityUtils authorityUtils;

    public SecurityConfiguration(JwtTokenizer jwtTokenizer, JwtAuthorityUtils authorityUtils) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http)throws Exception{
        http
                .headers().frameOptions().sameOrigin()
                .and()
                .csrf().disable() //ë°°í¬í•  ë•Œë§Œ ë³€ê²½í•˜ë©´ ë¨.
                .cors(withDefaults())
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
	               // ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ì„¤
                .and()
                .formLogin().disable() //í¼ë¡œê·¸ì¸ ì‚¬ìš©í•˜ì§€ ì•Šê²Ÿë‹¤.
                .httpBasic().disable()
                .apply(new CustomFilterConfigurer())
                .and()
                .authorizeHttpRequests(authorize -> authorize.anyRequest().permitAll());
                //ì¸ì¦ì¸ê°€ í›„ ë³€ê²½ì˜ˆì •

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    //Corsì„¤ì • ì¶”ê°€, corsConfigurationSourceë¥¼ ë¹ˆìœ¼ë¡œ ë™ë¡
    @Bean
    CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST","PATCH","DELETE"));
        UrlBasedCorsConfigurationSource source  = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**",configuration);
       return source;
    }

    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer,HttpSecurity>{
        @Override
        public void configure(HttpSecurity builder){
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login"); //ì—†ì„ë•ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì ìš©ë¨ ("/login)
            jwtAuthenticationFilter.setAuthenticationSuccessHandler(new MemberAuthenticationSuccessHandler());
            jwtAuthenticationFilter.setAuthenticationFailureHandler(new MemberAuthenticationFailureHandler());

            JwtVerifiedFilter jwtVerifiedFilter = new JwtVerifiedFilter(jwtTokenizer,authorityUtils);
            //JwtVerificationFilterì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ë©´ì„œ 
            //JwtVerificationFilterì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°ì²´ë“¤ì„ ìƒì„±ìë¡œ DIë¥¼ í•´ì¤€ë‹¤.

            builder.addFilter(jwtAuthenticationFilter)
                    .addFilterAfter(jwtVerifiedFilter,JwtVerifiedFilter.class);
                    //jwtAuthenticationFilterì—ì„œ ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•œ í›„ ë°œê¸‰ë°›ì€ JWTê°€ í´ë¼ì´ì–¸íŠ¸ì˜ request header(Authorization í—¤ë”)ì— í¬í•¨ë˜ì–´ ìˆì„ ê²½ìš°ì—ë§Œ ë™ì‘
        }
    }
}

```

- SessionCreationPolicyì˜ ì„¤ì • ê°’
    - SessionCreationPolicy.ALWAYS : í•­ìƒ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - SessionCreationPolicy.NEVER : ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šì§€ë§Œ ë§Œì•½ì— ì´ë¯¸ ìƒì„±ëœ ì„¸ì…˜ì´ ìˆë‹¤ë©´ ì‚¬ìš©í•œë‹¤.
    - SessionCreationPolicy.IF_REQUIRED :í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì„¸ì…˜ì„ ìƒì„±í•œë‹¤.
    - SessionCreationPolicy.STATELESS : ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šìœ¼ë©°, SecurityContext ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ ê²°ì½” ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

### ì„œë²„ ì¸¡ ë¦¬ì†ŒìŠ¤ì— ì—­í• (Role) ê¸°ë°˜ ê¶Œí•œ ì ìš©

**SecurityConfiguration**

```java
package com.springboot.config;

import com.springboot.auth.filter.JwtAuthenticationFilter;
import com.springboot.auth.filter.JwtVerifiedFilter;
import com.springboot.auth.handler.MemberAuthenticationFailureHandler;
import com.springboot.auth.handler.MemberAuthenticationSuccessHandler;
import com.springboot.auth.jwt.JwtTokenizer;
import com.springboot.auth.utils.JwtAuthorityUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;
    private final JwtAuthorityUtils authorityUtils;

    public SecurityConfiguration(JwtTokenizer jwtTokenizer, JwtAuthorityUtils authorityUtils) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http)throws Exception{
        http
                .headers().frameOptions().sameOrigin()
                .and()
                .csrf().disable() //ë°°í¬í•  ë•Œë§Œ ë³€ê²½í•˜ë©´ ë¨.
                .cors(withDefaults())
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                .formLogin().disable() //í¼ë¡œê·¸ì¸ ì‚¬ìš©í•˜ì§€ ì•Šê²Ÿë‹¤.
                .httpBasic().disable()
                .apply(new CustomFilterConfigurer())
                .and()
              //  .authorizeHttpRequests(authorize -> authorize.anyRequest().permitAll())
                //  ì¸ì¦ì¸ê°€ êµ¬í˜„ í›„ ì¶”ê°€
                .authorizeHttpRequests(authorize -> authorize
                        .antMatchers(HttpMethod.POST, "/*/members").permitAll() //postì— í•´ë‹¹í•œë‹¤ë©´ ì ‘ê·¼ í—ˆìš©
                        .antMatchers(HttpMethod.PATCH, "/*/members/**").hasRole("USER")
                        .antMatchers(HttpMethod.GET, "/*/members").hasRole("ADMIN")
                        .antMatchers(HttpMethod.GET, "/*/members/**").hasAnyRole("USER", "ADMIN")
                        .antMatchers(HttpMethod.DELETE, "/*/members/**").hasRole("USER")
                        .anyRequest().permitAll()
                );
        return http.build();

    }

    @Bean
    public PasswordEncoder passwordEncoder(){
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    //Corsì„¤ì • ì¶”ê°€, corsConfigurationSourceë¥¼ ë¹ˆìœ¼ë¡œ ë™ë¡
    @Bean
    CorsConfigurationSource corsConfigurationSource(){
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST","PATCH","DELETE"));
        UrlBasedCorsConfigurationSource source  = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**",configuration);
       return source;
    }

    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer,HttpSecurity>{
        @Override
        public void configure(HttpSecurity builder){
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login"); //ì—†ì„ë•ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì ìš©ë¨ ("/login)
            jwtAuthenticationFilter.setAuthenticationSuccessHandler(new MemberAuthenticationSuccessHandler());
            jwtAuthenticationFilter.setAuthenticationFailureHandler(new MemberAuthenticationFailureHandler());

            JwtVerifiedFilter jwtVerifiedFilter = new JwtVerifiedFilter(jwtTokenizer,authorityUtils);

            builder.addFilter(jwtAuthenticationFilter)
                    .addFilterAfter(jwtVerifiedFilter,JwtAuthenticationFilter.class);
        }
    }
}

```