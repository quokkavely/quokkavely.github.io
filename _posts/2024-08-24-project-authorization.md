---
layout : single
title : "[Project] authentication NPE"
categories: Project
tag : [project1, practice]
author_profile: true
---

📌 개인적인 공간으로 공부를 기록하고 복습하기 위해 사용하는 블로그입니다. <br>
정확하지 않은 정보가 있을 수 있으니 참고바랍니다 :😸 <br>
[틀린 내용은 댓글로 남겨주시면 복받으실거에요]  
{: .notice--primary}

---

## Authorization을 넣지 않았을 때 NPE 발생

최근에 사용자가 게시글을 작성하는 엔드포인트를 호출할 때, Authentication 과정에서 NPE(NullPointerException)가 발생하는 문제를 겪었다. 코드 합치고 테스트 시작하고 있는데 게시글 작성시에 Authorization을 넣지 않으면 발생하는 예외가 꽤나 거슬려서 이걸 꼭 잡고 가야겠다는 생각이 들었고 Security 담당이 나였는데 이게 왜 터지지라는 생각이 들었다..

보안 관련 예외라서 인증된 사용자인지 확인하는 과정에서 문제가 생긴 건데, 이게 컨트롤러 레벨에서 터져서 당황스러웠다. 다양한 방법을 시도해봤는데, 결국 해결은 했지만 그 과정이 만만치 않았다.

<img src= "https://github.com/user-attachments/assets/f455fc92-fe82-4ce6-8e34-9823f7883ad9" width=500/>

### 첫 번째 시도: 컨트롤러에서 예외 처리

<img src="https://github.com/user-attachments/assets/b30589c0-33e2-4e44-abd5-aae8b868f910" width=500/>

처음엔 예외가 컨트롤러에서 발생하니까, 모든 엔티티 컨트롤러에서 이 예외를 처리하는 방법을 고려했다. 각 컨트롤러에 예외 처리를 추가해서 NPE가 터지면 캐치(catch)하고, 적절한 응답을 반환하는 식으로 코드를 수정할 생각이었다. 근데 이렇게 하면 문제가 두 가지 있었다.

1. **유지보수성 저하**: 모든 컨트롤러에 예외 처리를 넣으면 코드가 복잡해지고 유지보수가 어려워진다. 게다가 컨트롤러마다 똑같은 예외 처리 로직을 추가하는 건 코드 중복을 일으키고, 새로운 컨트롤러를 추가할 때마다 이 작업을 반복해야 하는 번거로움이 생긴다.
2. **근본적인 문제 해결이 안 됨**: 사실 NPE가 컨트롤러에서 터진 건 맞지만, 근본적인 문제는 Authentication 과정에 있었다. 그래서 컨트롤러 레벨에서 예외를 처리하는 건 임시방편일 뿐, 진짜 원인을 해결하는 게 아니었다.

### 두 번째 시도: Security Configuration에서 문제 해결

그래서 보안 설정(SecurityConfiguration) 쪽에서 예외를 처리하는 방법으로 방향을 틀었다. 인증 과정에서 발생하는 예외니까, Spring Security의 필터나 엔트리 포인트에서 처리하는 게 더 맞다고 판단했다.

- **JwtVerifiedFilter**: JWT 토큰 검증 과정에서 예외가 터질 수 있어서, 이 필터에서 NPE를 캐치하고 적절한 예외 메시지를 반환하려고 했다. 근데 이 방법만으로는 문제가 해결되지 않았다. 필터에서 예외를 처리한다고 근본적인 문제가 사라지진 않아서였다.
- **EntryPoint**: 인증되지 않은 사용자가 접근할 때 예외를 처리하는 엔트리 포인트에서 NPE를 처리해보려고 했다. 이 방법도 일부 경우에는 유용했지만, 여전히 NPE 문제를 완전히 해결하진 못했다. EntryPoint는 주로 인증 실패 시의 처리를 담당하는데, 근본적인 원인은 SecurityConfiguration 설정 누락에 있었기 때문이다.

### 최종 원인 파악: Security Configuration의 설정 누락

여러 시도 끝에 결국 진짜 문제의 원인을 찾아냈다. 바로 `SecurityConfiguration`에서 게시글 작성 엔드포인트에 대한 설정이 누락되어 있었다. 이 설정이 빠져서 인증 과정에서 발생한 예외를 제대로 처리하지 못하고 NPE가 터졌던 거다.

보안 설정을 다시 살펴보니, 특정 엔드포인트에 대해 JWT 검증이나 권한 설정이 제대로 안 돼 있어서 인증 객체가 `null`인 상태로 접근이 이루어졌고, 그 결과 NPE가 발생한 거였다.

<img src="https://github.com/user-attachments/assets/3aa7e1a4-cd4b-4184-99f2-fa80b62f16d2" width=500/>

### 문제 해결: Security Configuration 수정

문제를 해결하기 위해 `SecurityConfiguration`에서 누락된 엔드포인트 설정을 추가했다. 게시글 작성 엔드포인트에 대해 적절한 권한 검증과 JWT 토큰 검사를 추가했고, 덕분에 인증 과정에서 발생할 수 있는 예외를 사전에 방지할 수 있었다.

이제 NPE가 발생하지 않고, 정상적으로 인증된 사용자가 게시글을 작성할 수 있게 됐다. 이번 일을 통해 배운 점은, 보안 설정에서 작은 누락도 큰 문제를 일으킬 수 있다는 것이다. 단순히 컨트롤러나 필터 레벨에서 예외를 처리하는 것만으론 부족하고, 보안 설정 전반을 꼼꼼히 살펴보는 게 중요하다는 걸 다시 한번 느꼈다.