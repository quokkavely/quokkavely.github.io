---
layout : single
title : "[MSA] chapter 3_Spring Cloud gateway ì„¤ì •"
categories: MSA
tag : [MSA, SpringCloud]
author_profile: true
---

ğŸ“Œ ê°œì¸ì ì¸ ê³µê°„ìœ¼ë¡œ ê³µë¶€ë¥¼ ê¸°ë¡í•˜ê³  ë³µìŠµí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. <br>
ì •í™•í•˜ì§€ ì•Šì€ ì •ë³´ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ë°”ëë‹ˆë‹¤ :ğŸ˜¸ <br>
[í‹€ë¦° ë‚´ìš©ì€ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ ë³µë°›ìœ¼ì‹¤ê±°ì—ìš”]  
{: .notice--primary}

ì¸í”„ëŸ° Dowon Leeë‹˜ì˜ Spring Cloudë¡œ ê°œë°œí•˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜(MSA) ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤.ğŸ˜Š<br>
[Spring Cloudë¡œ ê°œë°œí•˜ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜(MSA) ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸°ğŸ‘©â€ğŸ«](https://inf.run/GHeRm)
{: .notice--warning}


## gateway ì‹¤ìŠµ 1 :  application.ymlì—ì„œ ì„¤ì •

1. build.gradle
    
    `spring-cloud-starter-gateway`ëŠ” Gateway ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, WebFluxë¥¼ í†µí•´ Netty ì„œë²„ì—ì„œ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ì§€ì›í•œë‹¤.
    
    ```java
    plugins {
    	id 'org.springframework.boot' version '2.7.0'
    	id 'io.spring.dependency-management' version '1.0.13.RELEASE'
    	id 'java'
    }
    ext {
    	set('springCloudVersion', "2021.0.3")
    }
    dependencies {
    	implementation 'org.springframework.boot:spring-boot-starter-webflux'
    	implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    	implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    	compileOnly 'org.projectlombok:lombok'
    	annotationProcessor 'org.projectlombok:lombok'
    }
    
    dependencyManagement {
    	imports {
    		mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
    	}
    }
    ```
    
2. application.yml
    
    Gateway ì„¤ì • íŒŒì¼ì—ì„œ Gatewayì˜ í¬íŠ¸, Eurekaì™€ì˜ ì—°ë™, ê·¸ë¦¬ê³  ê° ë¼ìš°íŠ¸(route)ë¥¼ ì •ì˜í•œë‹¤.
    
    ```java
    server:
      port: 8000  # API GatewayëŠ” 8000 í¬íŠ¸ì—ì„œ ì‹¤í–‰
    
    eureka:
      client:
        register-with-eureka: true
        fetch-registry: true
        service-url:
          defaultZone: http://127.0.0.1:8761/eureka  # Eureka ì„œë²„ URL ì„¤ì •
    
    spring:
      application:
        name: api-gateway
      cloud:
        gateway:
          routes:
            - id: auth-api
              uri: http://localhost:8081
              predicates:
                - path=/auth-api/**
            - id: core-api
              uri: http://localhost:8082
              predicates:
                - path=/core-api/**
    ```
    
    - **Eureka ì„¤ì •**: Gatewayê°€ Eureka ì„œë²„ì™€ í†µì‹ í•˜ì—¬ ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ ì„¤ì •í•œë‹¤.
    - **Route ì„¤ì •**:
        - `/auth-api/**` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì€ `http://localhost:8081`ì— ë°°ì¹˜ëœ `auth-api`ë¡œ ë¼ìš°íŒ…ëœë‹¤.
        - `/core-api/**` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì€ `http://localhost:8082`ì— ë°°ì¹˜ëœ `core-api`ë¡œ ë¼ìš°íŒ…ëœë‹¤.
    
    ì´ë¡œì¨ GatewayëŠ” `/auth-api/**` ë° `/core-api/**` ê²½ë¡œì˜ ìš”ì²­ì„ ê°ê°ì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ë¶„ë°°í•  ìˆ˜ ìˆê²Œ ëœë‹¤.
    
3. Netty ì‹¤í–‰ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
    
    <img src="https://github.com/user-attachments/assets/d29aa70c-0ff1-4a9d-959c-b91e738cc241" width=500/>
    
    ê¸°ì¡´ì˜ í†°ìº£ ì„œë²„ê°€ ì•„ë‹Œ **Netty ì„œë²„**ê°€ Spring Cloud Gatewayì—ì„œ ì‘ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ëŠ” **Spring WebFlux**ê°€ ë¹„ë™ê¸° í™˜ê²½ì„ ì§€ì›í•˜ê¸° ìœ„í•´ Netty ì„œë²„ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì´ë©°, Spring Cloud GatewayëŠ” ì´ëŸ¬í•œ ë¹„ë™ê¸° ì²˜ë¦¬ì— ìµœì í™”ë˜ì–´ ìˆë‹¤.
    

1. ê·¼ë° 404?ê°€ ë‚˜ì˜´
    
    ì™œëƒë©´ [`http://localhost:8082/core-api/**`](http://localhost:8081/auth-api/**) ì´ë ‡ê²Œ ìš”ì²­ì´ ê°€ê¸°ë•Œë¬¸ì´ë‹¤.
    
    í•˜ì§€ë§Œ ì‹¤ì œ ì„œë¹„ìŠ¤ëŠ” ì•„ë˜ ì£¼ì„ê³¼ ê°™ì´ [localhost:8082/documents](http://localhost:8082/documents) ë¡œ ë˜ì–´ìˆë‹¤. ê·¸ë˜ì„œ ë”°ë¡œ ì²˜ë¦¬í•´ì£¼ì–´ì•¼ í•œë‹¤.
    

<img src="https://github.com/user-attachments/assets/b8496657-0fbb-415e-aea2-bec70ac80e75" width=500/>
    
  - Spring Cloud Gatewayì˜ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ **ê²½ë¡œë¥¼ ì¬ì„¤ì •**í•˜ê±°ë‚˜ **í”„ë¦¬í•„í„°ë¥¼ í†µí•´ ê²½ë¡œë¥¼ `/documents`ë¡œ ë³€ê²½**í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ Gatewayê°€ ìš”ì²­ ê²½ë¡œë¥¼ ì˜¬ë°”ë¥´ê²Œ ë§¤í•‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
  - 404 ë‚˜ì˜¨ ì—ëŸ¬ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ymlì—ì„œ ìˆ˜ì •í•˜ê±°ë‚˜ java codeë¡œ í•„í„°ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
        
     ```java
        routes:
              - id: core-api
                uri: http://localhost:8082   # ì‹¤ì œ core-api ì„œë¹„ìŠ¤ URL
                predicates:
                  - Path=/core-api/**
                filters:
                  - RewritePath=/core-api/(?<segment>.*), /documents/${segment}  # ê²½ë¡œ ë³€ê²½ í•„í„°
      ``` 
        

ymlì—ì„œ ìˆ˜ì •í•˜ëŠ” ë°©ë²• ì™¸ì— java codeë¡œ í•„í„°ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆëŠ”ë° ì•„ë˜ì™€ ê°™ë‹¤.

## gateway ì‹¤ìŠµ 1 : java code ë¡œ ì„¤ì • (Spring Cloud Gatewayì™€ í•„í„° êµ¬ì„± ìš”ì†Œ)

**Spring Cloud Gateway**ëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ì´ ê³¼ì •ì—ì„œ ìš”ì²­ì„ ì „ì²˜ë¦¬í•˜ê±°ë‚˜ í›„ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” **í•„í„°** ê¸°ëŠ¥ì„ ì œê³µí•´, ìš”ì²­ì˜ íë¦„ì„ ìœ ì—°í•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆë‹¤.

<img src="https://github.com/user-attachments/assets/65cf9b00-f3ec-4b0c-a7f1-09bfbcfaaae8" width=500/>

### ì£¼ìš” í•„í„° êµ¬ì„± ìš”ì†Œ

- **í”„ë ˆë””ì¼€ì´íŠ¸(Predicate)**: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ íŒë‹¨í•˜ëŠ” ì—­í• ì„ í•˜ë©°, ì¡°ê±´ì— ë”°ë¼ ìš”ì²­ì„ ë¼ìš°íŒ…í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, URL ê²½ë¡œë‚˜ í—¤ë” ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•  ìˆ˜ ìˆë‹¤.
- **í”„ë¦¬í•„í„°(Pre-Filter)**: ìš”ì²­ì´ ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ì „ë‹¬ë˜ê¸° **ì „ì—** ì‹¤í–‰ë˜ëŠ” í•„í„°ë¡œ, ìš”ì²­ í—¤ë” ì¶”ê°€ë‚˜ ìš”ì²­ ë°ì´í„° ìˆ˜ì • ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.
- **í¬ìŠ¤íŠ¸í•„í„°(Post-Filter)**: ìš”ì²­ì´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì²˜ë¦¬ëœ **í›„ì—** ì‹¤í–‰ë˜ëŠ” í•„í„°ë¡œ, ì‘ë‹µ í—¤ë” ì¶”ê°€ë‚˜ ì‘ë‹µ ë°ì´í„° ìˆ˜ì • ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

ìš”ì²­ ì •ë³´ê°€ ë“¤ì–´ì˜¤ê²Œ ë˜ë©´ ê·¸ê²Œ ì–´ë–¤ ê²ƒì¸ì§€ íŒë‹¨í•˜ëŠ” ê²Œ í”„ë¦¬í‹°ì¼€ì´íŠ¸ê³  í”„ë¦¬í•„í„°ëŠ” ì–´ë–¤ì‘ì—…ì´ ì¼ì–´ë‚˜ê¸° ì‚¬ì „ í•„í„°, ì–´ë–¤ ì²˜ë¦¬ê°€ ëë‚œ ë‹¤ìŒì— í˜¸ì¶œë˜ëŠ” í¬ìŠ¤íŠ¸í•„í„°ê°€ ë‚˜ëˆ ì§„ë‹¤.

### ì½”ë“œ ì˜ˆì‹œë¥¼ í†µí•œ Spring Cloud Gateway ì„¤ì •

**Spring Cloud Gateway**ì—ì„œ ê²½ë¡œì™€ í•„í„°ë¥¼ ì„¤ì •í•˜ëŠ” ì½”ë“œë¡œ, ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œì˜ ìš”ì²­ì„ íŠ¹ì • ê²½ë¡œì— ë”°ë¼ ë¼ìš°íŒ…í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `/auth-api/**` ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì€ `auth-api` ì„œë¹„ìŠ¤ë¡œ, `/core-api/**` ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì€ `core-api` ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…ëœë‹¤.

```java
@Configuration
public class RouteLocatorConfig {
  @Bean
  public RouteLocator routeLocator(RouteLocatorBuilder builder, JwtFilter jwtFilter) {
      return builder.routes()
          .route("auth-api", r -> r.path("/auth-api/**")
                          .filters(f -> f.addRequestHeader("first-request", "first-request-header")
                                         .addResponseHeader("first-response", "first-response-header"))
                          .uri("http://localhost:8081/"))
          .route("core-api", r -> r.path("/core-api/**")
                          .filters(f -> f.addRequestHeader("second-request", "second-request-header")
                                         .addResponseHeader("second-response", "second-response-header"))
                          .uri("http://localhost:8082/"))
          .build();
  }
}

```

1. í•„í„° ì„¤ì •
    - `addRequestHeader`: í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ìš”ì²­ì— í—¤ë”ë¥¼ ì¶”ê°€í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, "first-request" í—¤ë”ë¥¼ "first-request-header" ê°’ìœ¼ë¡œ ì¶”ê°€í•˜ì—¬ **í”„ë¦¬í•„í„°**ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
    - `addResponseHeader`: ìš”ì²­ ì²˜ë¦¬ê°€ ì™„ë£Œëœ í›„ ì‘ë‹µì— í—¤ë”ë¥¼ ì¶”ê°€í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, "first-response" í—¤ë”ë¥¼ ì‘ë‹µì— í¬í•¨í•´ **í¬ìŠ¤íŠ¸í•„í„°**ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.
2. ë¼ìš°íŒ… íë¦„
    1. **í´ë¼ì´ì–¸íŠ¸ ìš”ì²­**: í´ë¼ì´ì–¸íŠ¸ëŠ” API Gatewayë¥¼ í†µí•´ `/auth-api/**` ë˜ëŠ” `/core-api/**` ê²½ë¡œë¡œ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
    2. **Spring Cloud Gateway ì²˜ë¦¬**: GatewayëŠ” ê²½ë¡œì— ë”°ë¼ ìš”ì²­ì„ ë¼ìš°íŒ…í•˜ê³ , í•„í„°ë¥¼ ì ìš©í•´ í—¤ë”ë¥¼ ì¶”ê°€í•œë‹¤.
    3. **í¼ìŠ¤íŠ¸ ì„œë¹„ìŠ¤ì™€ ì„¸ì»¨ë“œ ì„œë¹„ìŠ¤**: ê°ê°ì˜ ê²½ë¡œì— ë”°ë¼ 8081 í¬íŠ¸ì—ì„œ ë™ì‘í•˜ëŠ” `auth-api`ì™€ 8082 í¬íŠ¸ì—ì„œ ë™ì‘í•˜ëŠ” `core-api` ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ì´ ì „ë‹¬ëœë‹¤.
    4. **ì‘ë‹µ ë°˜í™˜**: ê° ì„œë¹„ìŠ¤ì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•œ í›„ ì‘ë‹µì„ ë°˜í™˜í•˜ë©°, í¬ìŠ¤íŠ¸í•„í„°ë¥¼ í†µí•´ ì‘ë‹µ í—¤ë”ê°€ ì¶”ê°€ëœë‹¤.

---

### í…ŒìŠ¤íŠ¸ ë° ì‘ë™ ê³¼ì •

- **í…ŒìŠ¤íŠ¸ í¬íŠ¸**: Gatewayê°€ 8000 í¬íŠ¸ì—ì„œ ì‘ë™í•˜ë©°, í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ í¬íŠ¸ë¥¼ í†µí•´ ìš”ì²­ì„ ë³´ë‚¸ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `http://localhost:8000/auth-api/...`ë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´, Spring Cloud Gatewayê°€ ìš”ì²­ì„ 8081 í¬íŠ¸ì˜ `auth-api`ë¡œ ë¼ìš°íŒ…í•œë‹¤.
- **í—¤ë” í™•ì¸**: Spring Cloud Gatewayì—ì„œ ì¶”ê°€í•œ ìš”ì²­ ë° ì‘ë‹µ í—¤ë” ê°’(`first-request-header` ë° `first-response-header` ë“±)ì„ í¼ìŠ¤íŠ¸ ì„œë¹„ìŠ¤ì™€ ì„¸ì»¨ë“œ ì„œë¹„ìŠ¤ì—ì„œ í™•ì¸í•˜ê³ , ì²˜ë¦¬ í›„ ì‘ë‹µìœ¼ë¡œ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.

---

### ìš”ì•½ğŸ‘©â€ğŸ«

Spring Cloud GatewayëŠ” í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ íŠ¹ì • ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ë©°, **í”„ë¦¬í•„í„°**ì™€ **í¬ìŠ¤íŠ¸í•„í„°**ë¥¼ í†µí•´ ìš”ì²­ ë° ì‘ë‹µì„ ìœ ì—°í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ API GatewayëŠ” ë¼ìš°íŒ… ì™¸ì—ë„, ë³´ì•ˆ, ë¡œê¹…, ì‘ë‹µ ìºì‹± ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ë©°, MSA í™˜ê²½ì—ì„œì˜ ìœ ì—°í•œ ì„œë¹„ìŠ¤ í†µì‹ ì„ ì§€ì›í•œë‹¤.